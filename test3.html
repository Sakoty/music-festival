<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Motion Sound Minimal</title>

<style>
body {
  margin: 0;
  height: 100vh;
  background: #0f1115;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
}
#app {
  background: #1b1f2a;
  border-radius: 18px;
  padding: 28px 30px;
  width: 320px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.5);
  text-align: center;
}
h1 {
  font-size: 18px;
  margin: 0 0 14px;
}
#status {
  margin-top: 10px;
  font-size: 14px;
  color: #9ee7ff;
}
#motion {
  margin-top: 12px;
  font-size: 13px;
  color: #aaa;
}
#hint {
  margin-top: 14px;
  font-size: 12px;
  color: #777;
}
.ready {
  color: #7CFF7C !important;
}
.detect {
  color: #FFD479 !important;
}
button {
  margin-top: 14px;
  padding: 10px 16px;
  border-radius: 10px;
  border: none;
  background: #0b84ff;
  color: #fff;
  font-weight: 600;
  cursor: pointer;
}
button:active {
  transform: scale(0.97);
}
</style>
</head>

<body>
<div id="app">
  <h1>Motion Sound Test</h1>
  <button id="startBtn">開始</button>
  <div id="status">待機中</div>
  <div id="motion">動き: ---</div>
  <div id="hint">タップ後、端末を振ってください</div>
</div>

<script>
/* =========================
   状態管理
   ========================= */
let audioCtx = null;
let ready = false;
let lastPlay = 0;

/* =========================
   DOM
   ========================= */
const startBtn = document.getElementById("startBtn");
const statusEl = document.getElementById("status");
const motionEl = document.getElementById("motion");

/* =========================
   Audio 初期化
   ========================= */
function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === "suspended") {
    audioCtx.resume();
  }
}

/* =========================
   テスト音
   ========================= */
function playSound() {
  if (!audioCtx) return;

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "square";
  osc.frequency.value = 880;
  gain.gain.value = 0.25;

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start();
  osc.stop(audioCtx.currentTime + 0.12);
}

/* =========================
   モーション許可
   ========================= */
async function requestPermission() {
  if (
    typeof DeviceMotionEvent !== "undefined" &&
    typeof DeviceMotionEvent.requestPermission === "function"
  ) {
    const res = await DeviceMotionEvent.requestPermission();
    if (res !== "granted") {
      statusEl.textContent = "センサー許可が必要です";
      return false;
    }
  }
  return true;
}

/* =========================
   モーション検知
   ========================= */
function startMotion() {
  window.addEventListener(
    "devicemotion",
    (e) => {
      if (!ready) return;

      const acc = e.accelerationIncludingGravity;
      if (!acc) return;

      const x = acc.x || 0;
      const y = acc.y || 0;
      const z = acc.z || 0;

      const power = Math.sqrt(x*x + y*y + z*z);
      motionEl.textContent = "動き: " + power.toFixed(2);

      const now = Date.now();
      if (power > 18 && now - lastPlay > 500) {
        lastPlay = now;
        playSound();
        statusEl.textContent = "動きを検知！";
        statusEl.classList.add("detect");
        setTimeout(() => statusEl.classList.remove("detect"), 200);
      }
    },
    { passive: true }
  );
}

/* =========================
   開始ボタン
   ========================= */
startBtn.addEventListener("click", async () => {
  if (ready) return;

  statusEl.textContent = "準備中…";

  const ok = await requestPermission();
  if (!ok) return;

  initAudio();
  playSound(); // 確実に音が鳴る確認用

  startMotion();
  ready = true;

  statusEl.textContent = "準備完了";
  statusEl.classList.add("ready");
  startBtn.disabled = true;
});
</script>
</body>
</html>
