<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Motion Learning + Custom Sound (MP3å¯¾å¿œ)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; padding: 20px; line-height: 1.6; }
button { padding: 10px 16px; margin-top: 10px; font-size: 16px; }
select, input[type=range], input[type=file] { font-size: 16px; padding: 4px; margin-top:4px; }
.block { margin-top: 20px; border: 1px solid #ccc; padding: 12px; border-radius: 8px; }
#status { margin-top: 20px; font-weight: bold; color: #333; }
</style>
</head>
<body>

<h2>Motion Learning & Custom Sound (MP3å¯¾å¿œ)</h2>

<div class="block">
  <button id="permBtn">å‹•ãã‚»ãƒ³ã‚µãƒ¼ & éŸ³ã®è¨±å¯</button>
  <p id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¾…æ©Ÿä¸­</p>
</div>

<div class="block">
  <h3>ğŸµ éŸ³ã®è¿½åŠ  / å‰²ã‚Šå½“ã¦ (MP3å¯¾å¿œ)</h3>
  <input type="file" id="soundFile" accept="audio/*">
  <select id="assignMotion">
    <option value="shake">å¼·ã„ã‚·ã‚§ã‚¤ã‚¯</option>
    <option value="x">å·¦å³ã®å‹•ã</option>
    <option value="y">ä¸Šä¸‹ã®å‹•ã</option>
    <option value="z">å‰å¾Œã®å‹•ã</option>
    <option value="learned">å­¦ç¿’ã—ãŸå‹•ã</option>
  </select>
  <button id="assignBtn">å‰²ã‚Šå½“ã¦ã‚‹</button>
  <p>å‰²ã‚Šå½“ã¦éŸ³æ•°: <span id="soundCount">0</span></p>
</div>

<div class="block">
  <h3>âš™ æ„Ÿåº¦è¨­å®š</h3>
  <label>æ„Ÿåº¦ï¼ˆæ•°å€¤ãŒå°ã•ã„ã»ã©æ•æ„Ÿï¼‰: <input type="range" id="sensitivity" min="5" max="20" value="10"></label>
</div>

<div class="block">
  <h3>ğŸ“š ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç¿’</h3>
  <button id="learnBtn">3ç§’é–“å­¦ç¿’</button>
</div>

<div class="block">
  <h3>ğŸ“ ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜</h3>
  <select id="presetList"></select>
  <button id="savePreset">ä¿å­˜</button>
  <button id="deletePreset">å‰Šé™¤</button>
</div>

<div class="block">
  <h3>ğŸ” æ¤œçŸ¥é–‹å§‹ / åœæ­¢</h3>
  <button id="startDetectBtn">æ¤œçŸ¥é–‹å§‹</button>
  <button id="stopDetectBtn">åœæ­¢</button>
</div>

<script>
let audioCtx = null;
let customSounds = {};  // motion: [AudioBuffer, ...]
let learnedMotion = [];
let isLearning = false;
let learnBuffer = [];
let isDetecting = false;

// ãƒ—ãƒªã‚»ãƒƒãƒˆ
let presets = {};
function loadPresets() {
  const saved = localStorage.getItem('motionPresets');
  if (saved) presets = JSON.parse(saved);
  refreshPresetList();
}
function refreshPresetList() {
  const list = document.getElementById('presetList');
  list.innerHTML = '';
  Object.keys(presets).forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    list.appendChild(opt);
  });
}

// è¨±å¯ãƒœã‚¿ãƒ³
document.getElementById('permBtn').addEventListener('click', async () => {
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (typeof DeviceMotionEvent.requestPermission === "function") {
      const res = await DeviceMotionEvent.requestPermission();
      if (res !== "granted") { alert("ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“"); return; }
    }
    document.getElementById('status').textContent = "âœ” è¨±å¯ã•ã‚Œã¾ã—ãŸ";
  } catch(e) { alert("è¨±å¯ã‚¨ãƒ©ãƒ¼: " + e); }
});

// éŸ³å‰²ã‚Šå½“ã¦
document.getElementById('assignBtn').addEventListener('click', async () => {
  const file = document.getElementById('soundFile').files[0];
  const motion = document.getElementById('assignMotion').value;
  if (!file) return alert("éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„");
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  try {
    const arrayBuffer = await file.arrayBuffer();
    const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer.slice(0));
    if (!customSounds[motion]) customSounds[motion] = [];
    customSounds[motion].push(audioBuffer);
    document.getElementById('soundCount').textContent = Object.values(customSounds).flat().length;
    document.getElementById('status').textContent = `'${motion}' ã«éŸ³ã‚’å‰²ã‚Šå½“ã¦ã¾ã—ãŸ`;
  } catch(err) {
    alert("éŸ³ãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•—: " + err);
  }
});

// å†ç”Ÿ
function playSound(motion) {
  if (!customSounds[motion] || customSounds[motion].length === 0) return;
  customSounds[motion].forEach(buf => {
    const src = audioCtx.createBufferSource();
    src.buffer = buf;
    src.connect(audioCtx.destination);
    src.start(0);
  });
}

// å­¦ç¿’
document.getElementById('learnBtn').addEventListener('click', () => {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  isLearning = true;
  learnBuffer = [];
  document.getElementById('status').textContent = "å­¦ç¿’ä¸­â€¦3ç§’é–“å‹•ã‹ã—ã¦ãã ã•ã„";
  setTimeout(() => {
    isLearning = false;
    learnedMotion = [...learnBuffer];
    document.getElementById('status').textContent = "å­¦ç¿’å®Œäº†ï¼";
  }, 3000);
});

// æ„Ÿåº¦
function getThreshold() {
  return Number(document.getElementById('sensitivity').value);
}

// æ¤œçŸ¥
let motionHandler = (e) => {
  const ax = e.accelerationIncludingGravity.x || 0;
  const ay = e.accelerationIncludingGravity.y || 0;
  const az = e.accelerationIncludingGravity.z || 0;
  const total = Math.sqrt(ax*ax + ay*ay + az*az);

  if (isLearning) { learnBuffer.push(total); return; }

  const threshold = getThreshold();

  if (learnedMotion.length > 10) {
    const recent = learnBuffer.slice(-learnedMotion.length);
    if (recent.length === learnedMotion.length) {
      let sum = 0;
      for (let i=0; i<learnedMotion.length; i++) sum += Math.abs(recent[i]-learnedMotion[i]);
      const sim = 1 - (sum/learnedMotion.length)/10;
      if (sim > 0.75) playSound("learned");
    }
  }

  if (total > threshold) playSound("shake");
  if (Math.abs(ax) > threshold) playSound("x");
  if (Math.abs(ay) > threshold) playSound("y");
  if (Math.abs(az) > threshold) playSound("z");

  learnBuffer.push(total);
  if (learnBuffer.length>200) learnBuffer.shift();
};

// æ¤œçŸ¥é–‹å§‹ / åœæ­¢
document.getElementById('startDetectBtn').addEventListener('click', () => {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (!isDetecting) {
    window.addEventListener("devicemotion", motionHandler);
    isDetecting = true;
    document.getElementById('status').textContent = "æ¤œçŸ¥ä¸­â€¦";
  }
});
document.getElementById('stopDetectBtn').addEventListener('click', () => {
  if (isDetecting) {
    window.removeEventListener("devicemotion", motionHandler);
    isDetecting = false;
    document.getElementById('status').textContent = "åœæ­¢ä¸­";
  }
});

// ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜ / å‰Šé™¤
document.getElementById('savePreset').addEventListener('click', () => {
  const name = prompt("ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›");
  if (!name) return;
  presets[name] = { learnedMotion };
  localStorage.setItem('motionPresets', JSON.stringify(presets));
  refreshPresetList();
});
document.getElementById('deletePreset').addEventListener('click', () => {
  const list = document.getElementById('presetList');
  const name = list.value;
  if (!name) return;
  delete presets[name];
  localStorage.setItem('motionPresets', JSON.stringify(presets));
  refreshPresetList();
});

// åˆæœŸãƒ­ãƒ¼ãƒ‰
loadPresets();

</script>
</body>
</html>
