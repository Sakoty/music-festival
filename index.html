<button id="perm">å‹•ä½œã‚»ãƒ³ã‚µãƒ¼ã‚’è¨±å¯</button>
<p id="status"></p>

<script>
document.getElementById("perm").addEventListener("click", async () => {

  // iPhone ä»¥å¤–ã¯è¨±å¯ä¸è¦
  if (typeof DeviceMotionEvent.requestPermission !== "function") {
    document.getElementById("status").textContent =
      "iPhoneä»¥å¤–ãªã®ã§è¨±å¯ã¯ä¸è¦ã§ã™";
    return;
  }

  try {
    // ğŸ”¥ Safari ãŒå”¯ä¸€è¨±å¯ã™ã‚‹å‘¼ã³å‡ºã—ä½ç½®
    const state = await DeviceMotionEvent.requestPermission();

    if (state === "granted") {
      document.getElementById("status").textContent = "âœ” è¨±å¯ã•ã‚Œã¾ã—ãŸ";
    } else {
      document.getElementById("status").textContent = "âŒ æ‹’å¦ã•ã‚Œã¾ã—ãŸ";
    }
  } catch (e) {
    document.getElementById("status").textContent = "ã‚¨ãƒ©ãƒ¼ï¼š" + e;
  }
});
</script>

<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Motion Sound â€” Card UIï¼ˆå®Œå…¨ç‰ˆï¼‰</title>
<style>
  :root{--bg:#fafbff;--card:#fff;--muted:#6b7280;--accent:#0b84ff}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,"Noto Sans JP";margin:0;background:var(--bg);color:#0b1720}
  .wrap{max-width:920px;margin:18px auto;padding:18px}
  h1{font-size:20px;margin:6px 0 14px}
  .card{background:var(--card);border:1px solid #e6e9ef;padding:14px;border-radius:12px;margin-bottom:14px;box-shadow:0 6px 18px rgba(11,20,34,0.03)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:10px;font-weight:600;cursor:pointer}
  button.ghost{background:#fff;color:#111;border:1px solid #e6e9ef}
  label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
  input[type=range]{width:100%}
  select,input[type=text],input[type=file]{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd}
  small{color:var(--muted)}
  #log{height:160px;overflow:auto;background:#0b1220;color:#d1d5db;padding:8px;border-radius:8px;font-family:monospace;font-size:12px}
  ul.list{list-style:none;padding:0;margin:8px 0}
  ul.list li{padding:8px;border-bottom:1px solid #f1f3f5;display:flex;justify-content:space-between;gap:8px;align-items:center}
  .muted{color:var(--muted)}
  canvas#viz{width:100%;height:120px;background:#03121a;border-radius:8px;display:block}
  .smallbtn{background:#fff;border:1px solid #e6e9ef;padding:6px 8px;color:#222;border-radius:8px}
  .row{display:flex;gap:8px;align-items:center}
  .footer{margin-top:12px;font-size:12px;color:var(--muted)}
  @media (max-width:520px){ .wrap{padding:12px} button{padding:8px 10px} }
</style>
</head>
<body>
<div class="wrap">
  <h1>Motion Sound â€” Card UIï¼ˆå®Œå…¨ç‰ˆï¼‰</h1>

  <!-- Card: Start / Permission -->
  <div class="card" id="card-permission">
    <h3>æº–å‚™ï¼ˆå¿…ãšæœ€åˆã«ã‚¿ãƒƒãƒ—ï¼‰</h3>
    <div class="controls">
      <button id="initBtn">é–‹å§‹ï¼ˆã‚¿ãƒƒãƒ—ã—ã¦è¨±å¯ï¼‰</button>
      <button id="startDetectBtn" class="ghost" disabled>æ¤œçŸ¥ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="stopDetectBtn" class="ghost" disabled>æ¤œçŸ¥åœæ­¢</button>
    </div>
    <p class="muted">iPhone ã§ã¯ã“ã®ã€Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’å¿…ãšã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
  </div>

  <!-- Card: Sound Assignment -->
  <div class="card" id="card-sound">
    <h3>éŸ³ã®è¿½åŠ  & å‰²ã‚Šå½“ã¦ï¼ˆ1å‹•ä½œã«è¤‡æ•°ç™»éŒ²å¯ï¼‰</h3>
    <label>éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
    <input id="fileInput" type="file" accept="audio/*" multiple>
    <label>å‰²ã‚Šå½“ã¦å…ˆ</label>
    <select id="motionSelect">
      <option value="shake">å¼·ã„ã‚·ã‚§ã‚¤ã‚¯</option>
      <option value="x">å·¦å³(X)</option>
      <option value="y">ä¸Šä¸‹(Y)</option>
      <option value="z">å‰å¾Œ(Z)</option>
      <option value="learned">å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³</option>
    </select>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="assignFiles">ç™»éŒ²</button>
      <button id="clearMotionSounds" class="ghost">é¸æŠãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã®éŸ³ã‚’ã‚¯ãƒªã‚¢</button>
    </div>
    <p id="assignMsg" class="muted"></p>

    <h4 style="margin-top:12px">ç™»éŒ²æ¸ˆã¿ã®éŸ³ä¸€è¦§</h4>
    <ul id="soundLists" class="list"></ul>
  </div>

  <!-- Card: Sensitivity -->
  <div class="card" id="card-sens">
    <h3>æ„Ÿåº¦è¨­å®š</h3>
    <label>ã‚·ã‚§ã‚¤ã‚¯é–¾å€¤ (å°ã•ã„ã»ã©æ•æ„Ÿ)<br>
      <input id="shakeThresh" type="range" min="1.5" max="10" step="0.1" value="4">
    </label>
    <label>è»¸é–¾å€¤ (X/Y/Z ä¸€æ‹¬)<br>
      <input id="axisThresh" type="range" min="0.5" max="6" step="0.1" value="2">
    </label>
    <label>å­¦ç¿’ãƒãƒƒãƒé–¾å€¤ (DTW è·é›¢ã—ãã„å€¤ â€” å°ã•ã„ã»ã©å³ã—ã„)<br>
      <input id="matchThresh" type="range" min="0.1" max="10" step="0.1" value="2.5">
    </label>
    <label>ãƒˆãƒªã‚¬ãƒ¼å†·å´ (ms)<br>
      <input id="cooldown" type="range" min="200" max="5000" step="100" value="800">
    </label>
    <label>ãƒã‚¹ã‚¿ãƒ¼éŸ³é‡<br>
      <input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.8">
    </label>
  </div>

  <!-- Card: Learning -->
  <div class="card" id="card-learn">
    <h3>ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç¿’ï¼ˆ3ç§’ï¼‰</h3>
    <label>ãƒ‘ã‚¿ãƒ¼ãƒ³å <input id="patternName" type="text" placeholder="ä¾‹: 2å›ç¸¦ã«æŒ¯ã‚‹"></label>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="startLearn">å­¦ç¿’é–‹å§‹ï¼ˆ3ç§’ï¼‰</button>
      <button id="savePattern" class="ghost">ä¿å­˜</button>
      <button id="testPattern" class="ghost">ãƒ†ã‚¹ãƒˆ (æœ€è¿‘ã®è¨˜éŒ²ã§åˆ¤å®š)</button>
    </div>
    <p class="muted">å­¦ç¿’ã¯åˆæˆåŠ é€Ÿåº¦ï¼ˆtotalï¼‰ã‚’3ç§’é–“è¨˜éŒ²ã—ã¾ã™ã€‚ä¿å­˜ã¯ localStorageã€‚</p>
  </div>

  <!-- Card: Patterns / Presets -->
  <div class="card" id="card-patterns">
    <h3>ä¿å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ / ãƒ—ãƒªã‚»ãƒƒãƒˆ</h3>

    <h4>ä¿å­˜æ¸ˆã¿ãƒ‘ã‚¿ãƒ¼ãƒ³</h4>
    <ul id="patternList" class="list"></ul>

    <h4 style="margin-top:12px">ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆç¾åœ¨ã®è¨­å®šã‚’ä¿å­˜ï¼‰</h4>
    <label>ãƒ—ãƒªã‚»ãƒƒãƒˆå <input id="presetName" type="text" placeholder="ä¾‹: å…¬åœ’ç”¨-æ•æ„Ÿ"></label>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="savePreset">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä¿å­˜</button>
      <button id="loadPreset" class="ghost">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã‚€</button>
      <button id="deletePreset" class="ghost">ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’å‰Šé™¤</button>
    </div>
    <select id="presetList" style="margin-top:8px"></select>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="exportPatterns" class="ghost">ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (JSON)</button>
      <button id="importPatterns" class="ghost">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
    </div>
  </div>

  <!-- Card: Visual / Log -->
  <div class="card" id="card-visual">
    <h3>çŠ¶æ…‹ / å¯è¦–åŒ– / ãƒ­ã‚°</h3>
    <div id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¾…æ©Ÿä¸­</div>
    <canvas id="viz"></canvas>
    <h4 style="margin-top:10px">ãƒ­ã‚°</h4>
    <div id="log"></div>
    <div class="footer">ãƒ’ãƒ³ãƒˆ: è¨±å¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒå‡ºãªã„å ´åˆã¯å¿…ãšã€Œé–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„ã€‚</div>
  </div>
</div>

<script>
/* =============================
   å…¨éƒ¨å…¥ã‚Š â€” å®Œå…¨å®Ÿè£…
   ============================= */

/* ---------- Helpers & UI ---------- */
const statusEl = id => document.getElementById(id);
const logEl = document.getElementById('log');
function log(msg){
  const t = new Date().toLocaleTimeString();
  logEl.innerText = `[${t}] ${msg}\n` + logEl.innerText;
}
function status(txt){ document.getElementById('status').innerText = 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ' + txt; }

/* ---------- AudioContext & Master Gain ---------- */
let audioCtx = null;
let masterGain = null;
function initAudioIfNeeded(){
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = Number(document.getElementById('masterVol').value || 0.8);
    masterGain.connect(audioCtx.destination);
    // ensure resume on first user gesture
    document.addEventListener('click', ()=>{ if (audioCtx.state === 'suspended') audioCtx.resume(); }, { once:true });
    document.addEventListener('touchstart', ()=>{ if (audioCtx.state === 'suspended') audioCtx.resume(); }, { once:true });
    log('AudioContext åˆæœŸåŒ–');
  }
}
document.getElementById('masterVol').addEventListener('input', (e)=> {
  initAudioIfNeeded();
  const v = Number(e.target.value);
  if (masterGain) masterGain.gain.value = v;
  log(`ãƒã‚¹ã‚¿ãƒ¼éŸ³é‡: ${v}`);
});

/* ---------- Sound storage (motion -> array of {name, buf}) ---------- */
const soundMap = { shake: [], x: [], y: [], z: [], learned: [] };

async function decodeAudioSafe(arrayBuffer){
  initAudioIfNeeded();
  return new Promise((resolve, reject) => {
    try {
      const p = audioCtx.decodeAudioData(arrayBuffer.slice(0),
        (buf)=> resolve(buf),
        (err)=> reject(err));
      if (p && typeof p.then === 'function') p.then(resolve).catch(reject);
    } catch(e){
      reject(e);
    }
  });
}

/* Assign files to motion */
document.getElementById('assignFiles').addEventListener('click', async ()=>{
  const files = Array.from(document.getElementById('fileInput').files || []);
  const motion = document.getElementById('motionSelect').value;
  if (!files.length) { alert('éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  status('éŸ³ç™»éŒ²ä¸­...');
  initAudioIfNeeded();
  for (const f of files){
    try {
      const ab = await f.arrayBuffer();
      const buf = await decodeAudioSafe(ab);
      soundMap[motion].push({ name: f.name, buf });
      log(`ç™»éŒ²: ${f.name} -> ${motion}`);
    } catch(err){
      console.error(err);
      log(`ãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•—: ${f.name}`);
      alert(`${f.name} ã®ãƒ‡ã‚³ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ`);
    }
  }
  refreshSoundLists();
  status('ç™»éŒ²å®Œäº†');
});

/* Clear motion sounds */
document.getElementById('clearMotionSounds').addEventListener('click', ()=> {
  const motion = document.getElementById('motionSelect').value;
  if (!confirm(`${motion} ã®éŸ³ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  soundMap[motion] = [];
  refreshSoundLists();
  log(`${motion} ã®éŸ³ã‚’ã‚¯ãƒªã‚¢`);
});

/* refresh sound lists UI */
function refreshSoundLists(){
  const ul = document.getElementById('soundLists');
  ul.innerHTML = '';
  for (const k of Object.keys(soundMap)){
    if (!soundMap[k].length) continue;
    const li = document.createElement('li');
    const left = document.createElement('div');
    left.innerHTML = `<strong>${k}</strong> (${soundMap[k].length})`;
    const right = document.createElement('div');
    soundMap[k].forEach((s, idx)=>{
      const playBtn = document.createElement('button');
      playBtn.className='smallbtn';
      playBtn.textContent='â–¶';
      playBtn.addEventListener('click', ()=> playBuffer(s.buf));
      const delBtn = document.createElement('button');
      delBtn.className='smallbtn';
      delBtn.textContent='âœ•';
      delBtn.addEventListener('click', ()=>{
        soundMap[k].splice(idx,1);
        refreshSoundLists();
      });
      const span = document.createElement('span');
      span.style.marginLeft='6px';
      span.textContent = s.name;
      right.appendChild(playBtn);
      right.appendChild(delBtn);
      right.appendChild(span);
    });
    li.appendChild(left);
    li.appendChild(right);
    ul.appendChild(li);
  }
}

/* play a decoded buffer */
function playBuffer(buf){
  try {
    initAudioIfNeeded();
    const src = audioCtx.createBufferSource();
    src.buffer = buf;
    src.connect(masterGain);
    src.start();
  } catch(e){
    console.error('play error', e);
  }
}

/* play random one assigned to motion */
function playMotionRandom(motion){
  const arr = soundMap[motion] || [];
  if (!arr.length) return;
  const idx = Math.floor(Math.random()*arr.length);
  playBuffer(arr[idx].buf);
}

/* ---------- Sensitivity UI already exists ---------- */

/* ---------- Motion learning (3s) ---------- */
let isLearning = false;
let currentLearn = []; // raw totals recorded during learning
document.getElementById('startLearn').addEventListener('click', ()=>{
  currentLearn = [];
  isLearning = true;
  status('å­¦ç¿’ä¸­â€¦ï¼ˆ3ç§’ï¼‰');
  log('å­¦ç¿’é–‹å§‹');
  setTimeout(()=> {
    isLearning = false;
    status('å­¦ç¿’å®Œäº†ï¼ˆã¾ã ä¿å­˜ã—ã¦ã„ã¾ã›ã‚“ï¼‰');
    log(`å­¦ç¿’å®Œäº†: ${currentLearn.length} ã‚µãƒ³ãƒ—ãƒ«`);
  }, 3000);
});

/* ---------- Save pattern ---------- */
document.getElementById('savePattern').addEventListener('click', ()=>{
  const name = (document.getElementById('patternName').value || '').trim();
  if (!name) { alert('ãƒ‘ã‚¿ãƒ¼ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (currentLearn.length < 6) { alert('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒçŸ­ã™ãã¾ã™ã€‚å­¦ç¿’ã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚'); return; }
  const norm = resample(currentLearn, 60);
  const saved = loadPatterns();
  saved.push({ name, data: norm, created: Date.now() });
  localStorage.setItem('motionPatterns', JSON.stringify(saved));
  renderPatternList();
  log(`ãƒ‘ã‚¿ãƒ¼ãƒ³ä¿å­˜: ${name}`);
  alert('ä¿å­˜ã—ã¾ã—ãŸ');
});

/* test pattern against saved set using recent recorded currentLearn */
document.getElementById('testPattern').addEventListener('click', ()=>{
  const saved = loadPatterns();
  if (saved.length === 0) { alert('ä¿å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  if (currentLearn.length === 0) { alert('å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const cand = resample(currentLearn, 60);
  const results = saved.map(p => ({ name: p.name, score: dtwDistance(cand, p.data) }));
  results.sort((a,b)=>a.score-b.score);
  log('ãƒ†ã‚¹ãƒˆçµæœ: ' + JSON.stringify(results.slice(0,5)));
  alert('ãƒ†ã‚¹ãƒˆçµæœã‚’ãƒ­ã‚°ã«å‡ºã—ã¾ã—ãŸï¼ˆä¸Šä½5ä»¶ï¼‰');
});

/* ---------- Patterns list UI ---------- */
function loadPatterns(){ try { return JSON.parse(localStorage.getItem('motionPatterns')||'[]'); } catch(e){ return []; } }
function renderPatternList(){
  const arr = loadPatterns();
  const ul = document.getElementById('patternList');
  ul.innerHTML = '';
  arr.forEach((p, idx)=>{
    const li = document.createElement('li');
    li.style.display = 'flex'; li.style.justifyContent='space-between'; li.style.alignItems='center';
    const left = document.createElement('div');
    left.innerHTML = `<strong>${p.name}</strong><br><small class="muted">${new Date(p.created).toLocaleString()}</small>`;
    const right = document.createElement('div');
    const trig = document.createElement('button'); trig.className='smallbtn'; trig.textContent='â–¶ åˆ¤å®šãƒ†ã‚¹ãƒˆ';
    trig.addEventListener('click', ()=>{
      // Compare recent learnBuffer to this pattern
      if (currentLearn.length === 0) { alert('æœ€è¿‘ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      const cand = resample(currentLearn, 60);
      const score = dtwDistance(cand, p.data);
      alert(`ã‚¹ã‚³ã‚¢: ${score.toFixed(3)}ï¼ˆå°ã•ã„ã»ã©é¡ä¼¼ï¼‰`);
    });
    const del = document.createElement('button'); del.className='smallbtn'; del.textContent='å‰Šé™¤';
    del.addEventListener('click', ()=>{
      if (!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      arr.splice(idx,1);
      localStorage.setItem('motionPatterns', JSON.stringify(arr));
      renderPatternList();
      log(`ãƒ‘ã‚¿ãƒ¼ãƒ³å‰Šé™¤: ${p.name}`);
    });
    right.appendChild(trig); right.appendChild(del);
    li.appendChild(left); li.appendChild(right);
    ul.appendChild(li);
  });
}
renderPatternList();

/* ---------- Presets (save/load/delete) ---------- */
function loadPresets(){ try { return JSON.parse(localStorage.getItem('motionPresets')||'[]'); } catch(e){ return []; } }
function savePresets(arr){ localStorage.setItem('motionPresets', JSON.stringify(arr)); }
function refreshPresetList(){
  const list = document.getElementById('presetList');
  list.innerHTML = '';
  const arr = loadPresets();
  arr.forEach((p, idx)=>{
    const op = document.createElement('option');
    op.value = idx; op.textContent = p.name;
    list.appendChild(op);
  });
}
refreshPresetList();

document.getElementById('savePreset').addEventListener('click', ()=>{
  const name = (document.getElementById('presetName').value || '').trim();
  if (!name) { alert('ãƒ—ãƒªã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  // Gather current config: thresholds + assigned sound names
  const preset = {
    name,
    shakeThresh: Number(document.getElementById('shakeThresh').value),
    axisThresh: Number(document.getElementById('axisThresh').value),
    matchThresh: Number(document.getElementById('matchThresh').value),
    cooldown: Number(document.getElementById('cooldown').value),
    masterVol: Number(document.getElementById('masterVol').value),
    sounds: {}
  };
  // store only names for audio mapping; we cannot serialize AudioBuffer
  for (const k of Object.keys(soundMap)){
    preset.sounds[k] = soundMap[k].map(s => s.name);
  }
  const arr = loadPresets();
  arr.push(preset);
  savePresets(arr);
  refreshPresetList();
  log(`ãƒ—ãƒªã‚»ãƒƒãƒˆä¿å­˜: ${name}`);
  alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆéŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‚ç…§åã§ä¿å­˜ã•ã‚Œã¾ã™ï¼‰ã€‚åŒã˜éŸ³ã‚’åˆ¥ãƒ‡ãƒã‚¤ã‚¹ã§å¾©å…ƒã™ã‚‹å ´åˆã¯åŒåã®éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚');
});

document.getElementById('loadPreset').addEventListener('click', ()=>{
  const idx = document.getElementById('presetList').value;
  if (idx === '') { alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
  const arr = loadPresets();
  const preset = arr[Number(idx)];
  if (!preset) return;
  document.getElementById('shakeThresh').value = preset.shakeThresh;
  document.getElementById('axisThresh').value = preset.axisThresh;
  document.getElementById('matchThresh').value = preset.matchThresh;
  document.getElementById('cooldown').value = preset.cooldown;
  document.getElementById('masterVol').value = preset.masterVol;
  if (masterGain) masterGain.gain.value = preset.masterVol;
  // Note: sounds restored by filename require manual re-upload on this device.
  log(`ãƒ—ãƒªã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿: ${preset.name}ï¼ˆéŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯åå‰ã§å‚ç…§ã®ã¿ï¼‰`);
  alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ã¯å‚ç…§åã‚’ä¿æŒã—ã¾ã™ãŒã€éŸ³è‡ªä½“ã¯å†ç™»éŒ²ãŒå¿…è¦ã§ã™ã€‚');
});

document.getElementById('deletePreset').addEventListener('click', ()=>{
  const idx = document.getElementById('presetList').value;
  if (idx === '') return alert('ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’é¸ã‚“ã§ãã ã•ã„');
  const arr = loadPresets();
  const p = arr.splice(Number(idx),1);
  savePresets(arr);
  refreshPresetList();
  log(`ãƒ—ãƒªã‚»ãƒƒãƒˆå‰Šé™¤: ${p[0].name}`);
});

/* export/import patterns */
document.getElementById('exportPatterns').addEventListener('click', ()=>{
  const data = localStorage.getItem('motionPatterns') || '[]';
  const blob = new Blob([data], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'motion-patterns.json'; a.click();
  URL.revokeObjectURL(url);
});
document.getElementById('importPatterns').addEventListener('click', ()=> document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if (!f) return;
  f.text().then(txt=>{
    try{
      const parsed = JSON.parse(txt);
      localStorage.setItem('motionPatterns', JSON.stringify(parsed));
      renderPatternList();
      log('ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
    }catch(err){ alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“'); }
  });
});

/* ---------- DTW & utilities ---------- */
function dtwDistance(a, b){
  const n = a.length, m = b.length;
  if (n === 0 || m === 0) return Infinity;
  const INF = 1e9;
  const D = new Array(n+1);
  for (let i=0;i<=n;i++){ D[i] = new Array(m+1).fill(INF); }
  D[0][0]=0;
  for (let i=1;i<=n;i++){
    for (let j=1;j<=m;j++){
      const cost = Math.abs(a[i-1] - b[j-1]);
      D[i][j] = cost + Math.min(D[i-1][j], D[i][j-1], D[i-1][j-1]);
    }
  }
  return D[n][m] / (n+m);
}
function resample(arr, targetLen){
  if (arr.length === targetLen) return arr.slice();
  if (arr.length === 0) return new Array(targetLen).fill(0);
  const out = new Array(targetLen);
  for (let i=0;i<targetLen;i++){
    const t = i * (arr.length-1) / (targetLen-1);
    const lo = Math.floor(t), hi = Math.ceil(t);
    if (lo === hi) out[i] = arr[lo];
    else out[i] = arr[lo] * (hi - t) + arr[hi] * (t - lo);
  }
  return out;
}

/* ---------- Detection: device motion handler ---------- */
let vizBuffer = [];
const viz = document.getElementById('viz');
const vctx = viz.getContext('2d');
function drawViz(){
  const w = viz.width = viz.clientWidth * devicePixelRatio;
  const h = viz.height = viz.clientHeight * devicePixelRatio;
  vctx.clearRect(0,0,w,h);
  vctx.fillStyle = '#02121a';
  vctx.fillRect(0,0,w,h);
  if (!vizBuffer.length) return;
  vctx.lineWidth = 2 * devicePixelRatio;
  vctx.strokeStyle = '#0bffb3';
  vctx.beginPath();
  const N = vizBuffer.length;
  for (let i=0;i<N;i++){
    const x = i * w / (N-1);
    const y = h - Math.min(1, vizBuffer[i]/20) * h;
    if (i===0) vctx.moveTo(x,y); else vctx.lineTo(x,y);
  }
  vctx.stroke();
}
window.addEventListener('resize', drawViz);

let learnBuffer = []; // rolling buffer for detection
let lastTriggeredAt = {}; // cooldown

window.addEventListener('devicemotion', (ev)=>{
  const acc = ev.accelerationIncludingGravity || ev.acceleration;
  if (!acc) return;
  const ax = acc.x || 0, ay = acc.y || 0, az = acc.z || 0;
  const total = Math.sqrt(ax*ax + ay*ay + az*az);

  // viz
  vizBuffer.push(total);
  if (vizBuffer.length > 120) vizBuffer.shift();
  drawViz();

  // learning capture
  if (isLearning) {
    currentLearn.push(total);
  }

  // rolling buffer
  learnBuffer.push(total);
  if (learnBuffer.length > 1000) learnBuffer.shift();

  // only process when detection is started
  if (document.getElementById('startDetectBtn').disabled === false) return;

  // thresholds and cooldown
  const now = Date.now();
  const cooldownMs = Number(document.getElementById('cooldown').value);
  const shakeThreshold = Number(document.getElementById('shakeThresh').value);
  const axisThreshold = Number(document.getElementById('axisThresh').value);
  const matchThreshold = Number(document.getElementById('matchThresh').value);

  // 1) saved patterns detection (DTW)
  const saved = loadPatterns();
  if (saved.length > 0) {
    const candidate = resample(learnBuffer.slice(-240), 60);
    let best = null, bestScore = Infinity;
    for (const p of saved){
      const score = dtwDistance(candidate, p.data);
      if (score < bestScore){ bestScore = score; best = p; }
    }
    if (best && bestScore < matchThreshold) {
      if (!lastTriggeredAt['learned'] || now - lastTriggeredAt['learned'] > cooldownMs) {
        lastTriggeredAt['learned'] = now;
        status(`å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º: ${best.name}`);
        playMotionRandom('learned');
        log(`å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º: ${best.name} (score ${bestScore.toFixed(2)})`);
      }
    }
  }

  // 2) shake
  if (total > shakeThreshold) {
    if (!lastTriggeredAt['shake'] || now - lastTriggeredAt['shake'] > cooldownMs) {
      lastTriggeredAt['shake'] = now;
      status('ã‚·ã‚§ã‚¤ã‚¯æ¤œå‡º');
      playMotionRandom('shake');
      log('ã‚·ã‚§ã‚¤ã‚¯ã‚’ãƒˆãƒªã‚¬ãƒ¼');
    }
  }

  // 3) axis
  if (Math.abs(ax) > axisThreshold) {
    if (!lastTriggeredAt['x'] || now - lastTriggeredAt['x'] > cooldownMs) {
      lastTriggeredAt['x'] = now;
      status('Xè»¸å‹•ä½œæ¤œå‡º');
      playMotionRandom('x'); log('Xã‚’ãƒˆãƒªã‚¬ãƒ¼');
    }
  }
  if (Math.abs(ay) > axisThreshold) {
    if (!lastTriggeredAt['y'] || now - lastTriggeredAt['y'] > cooldownMs) {
      lastTriggeredAt['y'] = now;
      status('Yè»¸å‹•ä½œæ¤œå‡º');
      playMotionRandom('y'); log('Yã‚’ãƒˆãƒªã‚¬ãƒ¼');
    }
  }
  if (Math.abs(az) > axisThreshold) {
    if (!lastTriggeredAt['z'] || now - lastTriggeredAt['z'] > cooldownMs) {
      lastTriggeredAt['z'] = now;
      status('Zè»¸å‹•ä½œæ¤œå‡º');
      playMotionRandom('z'); log('Zã‚’ãƒˆãƒªã‚¬ãƒ¼');
    }
  }

});

/* ---------- Init / Permission / Start / Stop ---------- */
document.getElementById('initBtn').addEventListener('click', async ()=>{
  initAudioIfNeeded();
  // request permission for iOS Safari
  if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
    try {
      const res = await DeviceMotionEvent.requestPermission();
      if (res === 'granted') {
        status('ã‚»ãƒ³ã‚µãƒ¼è¨±å¯: granted');
        document.getElementById('startDetectBtn').disabled = false;
        log('Motion permission granted');
      } else {
        status('ã‚»ãƒ³ã‚µãƒ¼è¨±å¯: denied');
        alert('å‹•ãã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¿…è¦ã§ã™');
        log('Motion permission denied');
      }
    } catch(err){
      console.error(err);
      alert('requestPermission ã‚¨ãƒ©ãƒ¼');
      log('requestPermission error');
    }
  } else {
    document.getElementById('startDetectBtn').disabled = false;
    status('Motion API: ready');
    log('Motion API ready (no request needed)');
  }
});

document.getElementById('startDetectBtn').addEventListener('click', ()=>{
  document.getElementById('startDetectBtn').disabled = true;
  document.getElementById('stopDetectBtn').disabled = false;
  document.getElementById('initBtn').disabled = true;
  status('æ¤œçŸ¥ä¸­â€¦');
  log('æ¤œçŸ¥ã‚’é–‹å§‹');
});
document.getElementById('stopDetectBtn').addEventListener('click', ()=>{
  document.getElementById('startDetectBtn').disabled = false;
  document.getElementById('stopDetectBtn').disabled = true;
  document.getElementById('initBtn').disabled = false;
  status('åœæ­¢');
  log('æ¤œçŸ¥ã‚’åœæ­¢');
});

/* ---------- Ensure UI lists initial state ---------- */
refreshSoundLists();
renderPatternList();
refreshPresetList();
drawViz();

/* ---------- End of script ---------- */
</script>
</body>
</html>
