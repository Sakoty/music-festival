<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Motion Sound Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: Arial; padding: 20px; line-height: 1.6; }
  button { padding: 10px 16px; margin-top: 10px; font-size: 16px; }
  select, input { font-size: 16px; padding: 4px; }
  .block { margin-top: 20px; }
  #status { margin-top: 20px; font-weight: bold; color: #333; }
  .slider-container { margin-top: 10px; }
</style>
</head>
<body>

<h2>ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³éŸ³ã‚«ã‚¹ã‚¿ãƒ  PRO</h2>

<button id="permBtn">å‹•ãã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚’ä¸ãˆã‚‹</button><br>
<button id="startBtn" disabled>å‹•ä½œæ¤œçŸ¥ã‚’é–‹å§‹</button>

<div class="block">
  <h3>ğŸµ è‡ªåˆ†ã®éŸ³ã‚’è¿½åŠ ï¼ˆè¤‡æ•°ç™»éŒ²å¯ï¼‰</h3>
  <input type="file" id="soundFile" accept="audio/*" multiple>
  <p>é¸ã‚“ã éŸ³å£°ã‚’å‹•ãã«å‰²ã‚Šå½“ã¦ã‚‹ï¼ˆè¤‡æ•°å¯ï¼‰</p>

  <select id="assignMotion">
    <option value="shake">å¼·ã„ã‚·ã‚§ã‚¤ã‚¯</option>
    <option value="x">å·¦å³ã®å‹•ã</option>
    <option value="y">ä¸Šä¸‹ã®å‹•ã</option>
    <option value="z">å‰å¾Œã®å‹•ã</option>
    <option value="learned">å­¦ç¿’ã—ãŸå‹•ã</option>
  </select>

  <button id="assignBtn">å‰²ã‚Šå½“ã¦ã‚‹</button>

  <p id="assignResult"></p>
</div>

<div class="block slider-container">
  <h3>ğŸš æ„Ÿåº¦è¨­å®š</h3>
  ã‚·ã‚§ã‚¤ã‚¯æ„Ÿåº¦: <input type="range" id="shakeSens" min="2" max="10" step="0.1" value="4"><br>
  è»¸æ„Ÿåº¦(X,Y,Z): <input type="range" id="axisSens" min="1" max="5" step="0.1" value="2">
</div>

<div class="block">
  <h3>ğŸ“š ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç¿’</h3>
  <button id="learnBtn">å‹•ãã‚’å­¦ç¿’ï¼ˆ3ç§’ï¼‰</button>
</div>

<p id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¾…æ©Ÿä¸­</p>

<script>
let audioCtx;
let soundMap = { shake: [], x: [], y: [], z: [], learned: [] };
let learnedMotion = [];
let isLearning = false;
let learnBuffer = [];

// -------------------------------
// Audio åˆæœŸåŒ–ï¼ˆå¿…ãš1åº¦ï¼‰
// -------------------------------
function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

// Safari / iPhone å¯¾ç­–ï¼š1å›ã‚¯ãƒªãƒƒã‚¯ã§AudioContextã‚’çµ¶å¯¾ã«resume
document.addEventListener("touchstart", () => {
  if (audioCtx && audioCtx.state === "suspended") audioCtx.resume();
}, { once: true });

document.addEventListener("click", () => {
  if (audioCtx && audioCtx.state === "suspended") audioCtx.resume();
}, { once: true });

// -------------------------------
// éŸ³ã®ç™»éŒ²ï¼ˆè¤‡æ•°ç™»éŒ²OKï¼‰
// -------------------------------
async function registerSound(motion, buffer) {
  initAudio();
  const decoded = await audioCtx.decodeAudioData(buffer.slice(0));
  soundMap[motion].push(decoded);
}

// ãƒ©ãƒ³ãƒ€ãƒ ã§éŸ³ã‚’å†ç”Ÿ
function playSound(motion) {
  const list = soundMap[motion];
  if (!list || list.length === 0) return;

  initAudio();
  if (audioCtx.state === "suspended") audioCtx.resume();

  const buffer = list[Math.floor(Math.random() * list.length)];

  const src = audioCtx.createBufferSource();
  src.buffer = buffer;
  src.connect(audioCtx.destination);
  src.start();
}

// -------------------------------
// ã‚»ãƒ³ã‚µãƒ¼è¨±å¯
// -------------------------------
document.getElementById("permBtn").onclick = async () => {
  if (typeof DeviceMotionEvent.requestPermission === "function") {
    const res = await DeviceMotionEvent.requestPermission();
    if (res === "granted") {
      document.getElementById("startBtn").disabled = false;
      document.getElementById("status").textContent = "è¨±å¯ã•ã‚Œã¾ã—ãŸ";
    } else {
      alert("ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒå¿…è¦ã§ã™");
    }
  }
};

// -------------------------------
// éŸ³ã®å‰²ã‚Šå½“ã¦
// -------------------------------
document.getElementById("assignBtn").onclick = () => {
  const files = document.getElementById("soundFile").files;
  const motion = document.getElementById("assignMotion").value;
  if (files.length === 0) return alert("éŸ³ã‚’é¸ã‚“ã§ãã ã•ã„");

  Array.from(files).forEach(f => {
    f.arrayBuffer().then(buf => registerSound(motion, buf));
  });

  document.getElementById("assignResult").textContent =
    `${files.length} å€‹ã®éŸ³ã‚’ '${motion}' ã«ç™»éŒ²ã—ã¾ã—ãŸï¼`;
};

// -------------------------------
// ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç¿’
// -------------------------------
document.getElementById("learnBtn").onclick = () => {
  initAudio();
  isLearning = true;
  learnBuffer = [];
  document.getElementById("status").textContent = "å­¦ç¿’ä¸­â€¦ï¼ˆ3ç§’ï¼‰";

  setTimeout(() => {
    isLearning = false;
    learnedMotion = [...learnBuffer];
    document.getElementById("status").textContent =
      "å­¦ç¿’å®Œäº†ï¼å‹•ãã‚’å†ç¾ã™ã‚‹ã¨éŸ³ãŒé³´ã‚Šã¾ã™ã€‚";
  }, 3000);
};

// é¡ä¼¼åº¦è¨ˆç®—
function calcSimilarity(a, b) {
  if (a.length !== b.length) return 0;
  let total = 0;
  for (let i = 0; i < a.length; i++) {
    total += Math.abs(a[i] - b[i]);
  }
  return 1 - (total / a.length) / 10;
}

// -------------------------------
// å‹•ä½œæ¤œçŸ¥é–‹å§‹
// -------------------------------
document.getElementById("startBtn").onclick = () => {
  initAudio();
  document.getElementById("status").textContent = "æ¤œçŸ¥ä¸­â€¦";

  const shakeSens = document.getElementById("shakeSens");
  const axisSens = document.getElementById("axisSens");

  window.addEventListener("devicemotion", (ev) => {
    const ax = ev.accelerationIncludingGravity.x || 0;
    const ay = ev.accelerationIncludingGravity.y || 0;
    const az = ev.accelerationIncludingGravity.z || 0;

    const total = Math.sqrt(ax*ax + ay*ay + az*az);

    // å­¦ç¿’ä¸­
    if (isLearning) {
      learnBuffer.push(total);
      return;
    }

    // å­¦ç¿’åˆ¤å®š
    if (learnedMotion.length > 10) {
      const recent = learnBuffer.slice(-learnedMotion.length);
      const sim = calcSimilarity(recent, learnedMotion);
      if (sim > 0.75) playSound("learned");
    }

    // ã‚·ã‚§ã‚¤ã‚¯åˆ¤å®šï¼ˆå¯å¤‰ï¼‰
    if (total > Number(shakeSens.value)) playSound("shake");

    // è»¸ï¼ˆå¯å¤‰æ„Ÿåº¦ï¼‰
    const sens = Number(axisSens.value);
    if (Math.abs(ax) > sens) playSound("x");
    if (Math.abs(ay) > sens) playSound("y");
    if (Math.abs(az) > sens) playSound("z");

    // æ¯”è¼ƒãƒãƒƒãƒ•ã‚¡
    learnBuffer.push(total);
    if (learnBuffer.length > 400) learnBuffer.shift();
  });
};
</script>

</body>
</html>
