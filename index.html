<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Motion Learning + Custom Sound</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: Arial; padding: 20px; line-height: 1.6; }
  button { padding: 10px 16px; margin-top: 10px; font-size: 16px; }
  select, input { font-size: 16px; padding: 4px; }
  .block { margin-top: 20px; }
  #status { margin-top: 20px; font-weight: bold; color: #333; }
</style>
</head>
<body>

<h2>ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç¿’ & ã‚«ã‚¹ã‚¿ãƒ éŸ³ã‚·ã‚¹ãƒ†ãƒ </h2>

<button id="permBtn">å‹•ãã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ã‚’ä¸ãˆã‚‹</button><br>
<button id="startBtn" disabled>å‹•ä½œæ¤œçŸ¥ã‚’é–‹å§‹</button>

<div class="block">
  <h3>ğŸµ è‡ªåˆ†ã®éŸ³ã‚’è¿½åŠ </h3>
  <input type="file" id="soundFile" accept="audio/*">
  <p>é¸ã‚“ã éŸ³å£°ã‚’å‹•ãã«å‰²ã‚Šå½“ã¦ã‚‹</p>
  <select id="assignMotion">
    <option value="shake">å¼·ã„ã‚·ã‚§ã‚¤ã‚¯</option>
    <option value="x">å·¦å³ã®å‹•ã</option>
    <option value="y">ä¸Šä¸‹ã®å‹•ã</option>
    <option value="z">å‰å¾Œã®å‹•ã</option>
    <option value="learned">å­¦ç¿’ã—ãŸå‹•ã</option>
  </select>
  <button id="assignBtn">å‰²ã‚Šå½“ã¦ã‚‹</button>
</div>

<div class="block">
  <h3>ğŸ“š ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç¿’</h3>
  <button id="learnBtn">å‹•ãã‚’å­¦ç¿’ã™ã‚‹ï¼ˆ3ç§’ï¼‰</button>
  <p>â€» å­¦ç¿’å¾Œã€ãã®å‹•ããŒå†ç¾ã•ã‚Œã‚‹ã¨ã€Œå­¦ç¿’ã—ãŸå‹•ãã€ã¨ã—ã¦åˆ¤å®šã•ã‚Œã¾ã™</p>
</div>

<p id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¾…æ©Ÿä¸­</p>

<script>
let audioCtx;
let customSounds = {};       // motion â†’ AudioBuffer
let learnedMotion = [];      // å­¦ç¿’ãƒ‡ãƒ¼ã‚¿
let isLearning = false;
let learnBuffer = [];

// ------------------------------
// Audio åˆæœŸåŒ– + iPhoneå¯¾ç­–
// ------------------------------
function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

// ç”»é¢ã‚¿ãƒƒãƒ—ã§å¿…ãš AudioContext ã‚’å†é–‹ï¼ˆiPhoneå¯¾ç­–ï¼‰
document.addEventListener("click", () => {
  if (audioCtx && audioCtx.state === "suspended") {
    audioCtx.resume();
  }
}, { once: true });

// ------------------------------
// éŸ³ã‚’ç™»éŒ²ï¼ˆdecode ã¯æœ€åˆã®1å›ã ã‘ï¼‰
// ------------------------------
async function registerSound(motion, arrayBuffer) {
  initAudio();
  const decoded = await audioCtx.decodeAudioData(arrayBuffer.slice(0));
  customSounds[motion] = decoded;
}

// ------------------------------
// éŸ³ã‚’å†ç”Ÿ
// ------------------------------
function playSound(motion) {
  const buffer = customSounds[motion];
  if (!buffer) return;
  initAudio();

  const src = audioCtx.createBufferSource();
  src.buffer = buffer;
  src.connect(audioCtx.destination);
  src.start();
}

// ------------------------------
// é¡ä¼¼åº¦è¨ˆç®—
// ------------------------------
function calcSimilarity(arr1, arr2) {
  if (arr1.length !== arr2.length) return 0;
  let sum = 0;
  for (let i = 0; i < arr1.length; i++) {
    sum += Math.abs(arr1[i] - arr2[i]);
  }
  return 1 - (sum / arr1.length) / 10;
}

// ------------------------------
// ã‚»ãƒ³ã‚µãƒ¼è¨±å¯
// ------------------------------
document.getElementById("permBtn").onclick = async () => {
  if (typeof DeviceMotionEvent.requestPermission === "function") {
    const res = await DeviceMotionEvent.requestPermission();
    if (res === "granted") {
      document.getElementById("status").textContent = "è¨±å¯ã•ã‚Œã¾ã—ãŸ";
      document.getElementById("startBtn").disabled = false;
    } else {
      alert("ã‚»ãƒ³ã‚µãƒ¼ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“");
    }
  }
};

// ------------------------------
// éŸ³ã‚’å‰²ã‚Šå½“ã¦
// ------------------------------
document.getElementById("assignBtn").onclick = () => {
  const file = document.getElementById("soundFile").files[0];
  const motion = document.getElementById("assignMotion").value;
  if (!file) return alert("éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„");

  file.arrayBuffer().then(buf => {
    registerSound(motion, buf);
    document.getElementById("status").textContent =
      `éŸ³ã‚’ '${motion}' ã«å‰²ã‚Šå½“ã¦ã¾ã—ãŸ`;
  });
};

// ------------------------------
// ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç¿’
// ------------------------------
document.getElementById("learnBtn").onclick = () => {
  initAudio();
  isLearning = true;
  learnBuffer = [];
  document.getElementById("status").textContent = "å­¦ç¿’ä¸­ï¼ˆ3ç§’å‹•ã‹ã—ã¦ï¼‰â€¦";

  setTimeout(() => {
    isLearning = false;
    learnedMotion = [...learnBuffer];
    document.getElementById("status").textContent =
      "å­¦ç¿’å®Œäº†ï¼ã“ã®å‹•ãã‚’å†ç¾ã™ã‚‹ã¨éŸ³ãŒé³´ã‚Šã¾ã™ã€‚";
  }, 3000);
};

// ------------------------------
// å‹•ä½œæ¤œçŸ¥ã‚¹ã‚¿ãƒ¼ãƒˆ
// ------------------------------
document.getElementById("startBtn").onclick = () => {
  initAudio();
  document.getElementById("status").textContent = "æ¤œçŸ¥ä¸­â€¦";

  window.addEventListener("devicemotion", (e) => {

    const ax = e.accelerationIncludingGravity.x || 0;
    const ay = e.accelerationIncludingGravity.y || 0;
    const az = e.accelerationIncludingGravity.z || 0;

    const total = Math.sqrt(ax*ax + ay*ay + az*az);

    // ---- å­¦ç¿’ãƒ‡ãƒ¼ã‚¿åé›†ä¸­ ----
    if (isLearning) {
      learnBuffer.push(total);
      return;
    }

    // ---- å­¦ç¿’ã—ãŸå‹•ãã®åˆ¤å®š ----
    if (learnedMotion.length > 10) {
      const recent = learnBuffer.slice(-learnedMotion.length);
      const sim = calcSimilarity(recent, learnedMotion);
      if (sim > 0.75 && customSounds["learned"]) {
        playSound("learned");
        document.getElementById("status").textContent =
          `å­¦ç¿’ã—ãŸå‹•ãã‚’æ¤œçŸ¥ï¼ï¼ˆé¡ä¼¼åº¦: ${sim.toFixed(2)}ï¼‰`;
      }
    }

    // ---- å€‹åˆ¥ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ ----
    if (total > 4 && customSounds["shake"]) {
      playSound("shake");
      document.getElementById("status").textContent = "å¼·ã„ã‚·ã‚§ã‚¤ã‚¯ï¼";
    }

    if (Math.abs(ax) > 2 && customSounds["x"]) {
      playSound("x");
      document.getElementById("status").textContent = "å·¦å³ã®å‹•ãï¼";
    }

    if (Math.abs(ay) > 2 && customSounds["y"]) {
      playSound("y");
      document.getElementById("status").textContent = "ä¸Šä¸‹ã®å‹•ãï¼";
    }

    if (Math.abs(az) > 2 && customSounds["z"]) {
      playSound("z");
      document.getElementById("status").textContent = "å‰å¾Œã®å‹•ãï¼";
    }

    // ---- æ¯”è¼ƒç”¨ãƒãƒƒãƒ•ã‚¡ ----
    learnBuffer.push(total);
    if (learnBuffer.length > 200) learnBuffer.shift();
  });
};
</script>
</body>
</html>
