<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Motion → Sound 設定アプリ (完全版)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { font-size: 26px; }
    .block { border: 1px solid #ccc; padding: 15px; margin: 15px 0; border-radius: 10px; }
    input[type="range"] { width: 200px; }
  </style>
</head>
<body>
  <h1>Motion → Sound 設定アプリ（完全版）</h1>

  <!-- 1. 音の追加 -->
  <div class="block">
    <h2>1. 音ファイルを追加</h2>
    <input type="file" id="soundFile" accept="audio/*" />
    <button id="addSound">追加</button>
    <p>現在登録されている音：</p>
    <ul id="soundList"></ul>
  </div>

  <!-- 2. モーション学習 -->
  <div class="block">
    <h2>2. モーションを学習</h2>
    <button id="startLearn">学習開始</button>
    <button id="stopLearn">停止</button>
    <p>→ 学習したモーションは自動保存されます。</p>
    <ul id="patternList"></ul>
  </div>

  <!-- 3. 感度設定 -->
  <div class="block">
    <h2>3. モーション検知感度</h2>
    <label>
      感度（小さいほど敏感）
      <input type="range" id="sensitivity" min="5" max="100" value="30" />
    </label>
  </div>

  <!-- 4. 検知開始 -->
  <div class="block">
    <h2>4. 検知開始</h2>
    <button id="startDetect">検知スタート</button>
    <button id="stopDetect">停止</button>
  </div>

  <div class="block">
    <h2>ログ</h2>
    <div id="log" style="height:150px; overflow:auto; background:#f5f5f5; padding:10px;"></div>
  </div>

<script>
let sounds = []; // 登録した音
let patterns = []; // 学習したモーション
let learning = false;
let detecting = false;
let motionHistory = [];

// ログ表示
function log(t){
  const box = document.getElementById('log');
  box.innerHTML += t + '<br>';
  box.scrollTop = box.scrollHeight;
}

// 音追加
addSound.onclick = () => {
  const f = soundFile.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  sounds.push(new Audio(url));

  const li = document.createElement('li');
  li.textContent = f.name;
  soundList.appendChild(li);
};

// モーション記録
window.addEventListener('devicemotion', (e) => {
  if (!learning && !detecting) return;
  const { x, y, z } = e.accelerationIncludingGravity;
  motionHistory.push({ x, y, z, t: Date.now() });
  if (motionHistory.length > 50) motionHistory.shift();
});

// モーション学習開始\ nstartLearn.onclick = () => {
  learning = true;
  motionHistory = [];
  log('学習スタート');
};

// 学習停止\ nstopLearn.onclick = () => {
  learning = false;
  if (motionHistory.length > 10){
    patterns.push([...motionHistory]);
    savePatterns();
    log('モーション保存しました');
    renderPatterns();
  }
};

// パターン保存（ローカル）
function savePatterns(){
  localStorage.setItem('motionPatterns', JSON.stringify(patterns));
}
function loadPatterns(){
  const p = localStorage.getItem('motionPatterns');
  if (p) patterns = JSON.parse(p);
}
function renderPatterns(){
  patternList.innerHTML = '';
  patterns.forEach((p,i)=>{
    const li = document.createElement('li');
    li.textContent = 'パターン ' + (i+1) + '（' + p.length + ' 点）';
    patternList.appendChild(li);
  });
}

// 類似度計算（ざっくり）
function scorePattern(pat){
  let sum = 0;
  const len = Math.min(pat.length, motionHistory.length);
  for (let i=0;i<len;i++){
    const a = pat[i];
    const b = motionHistory[motionHistory.length-len+i];
    const d = Math.sqrt((a.x-b.x)**2 + (a.y-b.y)**2 + (a.z-b.z)**2);
    sum += d;
  }
  return sum / len;
}

// 全登録音を重ねて鳴らす
function playSound(){
  if (sounds.length === 0) return;
  sounds.forEach(o => {
    const s = new Audio(o.src);
    s.currentTime = 0;
    s.play();
  });
}

// 検知開始
startDetect.onclick = () => {
  detecting = true;
  log('検知開始');
};

stopDetect.onclick = () => {
  detecting = false;
  log('停止');
};

// 実際の判定処理\ nsetInterval(() => {
  if (!detecting || patterns.length === 0) return;

  let best = null;
  let bestScore = Infinity;

  patterns.forEach(p => {
    const s = scorePattern(p);
    if (s < bestScore){ bestScore = s; best = p; }
  });

  const threshold = Number(document.getElementById('sensitivity').value);

  if (best && bestScore < threshold){
    log('検知: スコア ' + bestScore.toFixed(1));
    playSound();
  }
}, 200);

// 起動時に読み込み\ nloadPatterns();
renderPatterns();
</script>

</body>
</html>
