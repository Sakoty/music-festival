<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Joy-Con ボタン入力テスト</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
<h2>Joy-Con ボタン→効果音テスト</h2>
<button id="connect">🎮 Joy-Con に接続</button>
<p id="status">未接続</p>

<!-- ボタン割当設定 -->
<div>
  <h3>ボタン → 再生音</h3>
  <label>Aボタン：<input id="soundA" type="text" value="soundA.mp3"></label><br>
  <label>Bボタン：<input id="soundB" type="text" value="soundB.mp3"></label><br>
  <label>Xボタン：<input id="soundX" type="text" value="soundX.mp3"></label><br>
  <label>Yボタン：<input id="soundY" type="text" value="soundY.mp3"></label><br>
</div>

<script>
let audioCtx;
let gamepadIndex = null;
let lastButtons = [];

async function playSound(url) {
  try {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      await audioCtx.resume();
    }
    const res = await fetch(url);
    const buf = await res.arrayBuffer();
    const audioBuffer = await audioCtx.decodeAudioData(buf);

    const src = audioCtx.createBufferSource();
    src.buffer = audioBuffer;
    src.connect(audioCtx.destination);
    src.start();
  } catch (e) {
    console.error("音声エラー", e);
  }
}

document.getElementById("connect").addEventListener("click", async () => {
  document.getElementById("status").textContent = "接続待機… (Joy-Con の任意のボタンを押す)";
});

window.addEventListener("gamepadconnected", (e) => {
  gamepadIndex = e.gamepad.index;
  lastButtons = e.gamepad.buttons.map(b => b.pressed);
  document.getElementById("status").textContent = "Joy-Con 接続成功！ index: " + gamepadIndex;
  updateLoop();
});

function updateLoop() {
  const gp = navigator.getGamepads()[gamepadIndex];
  if (!gp) return;

  gp.buttons.forEach((btn, i) => {
    if (btn.pressed && !lastButtons[i]) {
      // Joy-Con の一般的なボタン番号(A/B/X/Y)
      if (i === 1) playSound(document.getElementById("soundA").value); // A
      if (i === 0) playSound(document.getElementById("soundB").value); // B
      if (i === 3) playSound(document.getElementById("soundX").value); // X
      if (i === 2) playSound(document.getElementById("soundY").value); // Y
    }
  });

  lastButtons = gp.buttons.map(btn => btn.pressed);
  requestAnimationFrame(updateLoop);
}
</script>
</body>
</html>
