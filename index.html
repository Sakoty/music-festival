<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Motion → Sound（学習・保存対応）</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .box { border: 1px solid #ccc; padding: 16px; border-radius: 12px; margin-bottom: 20px; }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select, button { margin-top: 4px; }
    #log { white-space: pre-wrap; background: #f5f5f5; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Motion → Sound（任意動作の学習・音追加・パターン保存）</h1>

  <div class="box">
    <h2>1. 音ファイルの追加</h2>
    <input type="file" id="soundFile" accept="audio/*" />
    <button id="addSoundBtn">音を登録</button>
    <p>登録された音: <span id="soundCount">0</span></p>
  </div>

  <div class="box">
    <h2>2. 動作の学習（iPhoneモーション）</h2>
    <button id="startLearn">学習開始</button>
    <button id="stopLearn">学習停止</button>
    <p>現在の学習中パターン名: <input id="patternName" placeholder="例: 振る・ねじる" /></p>
  </div>

  <div class="box">
    <h2>3. 動作パターン一覧（保存対応）</h2>
    <select id="patternList"></select>
    <button id="deletePattern">削除</button>
  </div>

  <div class="box">
    <h2>4. 検知開始</h2>
<label>モーション検知感度（数値が小さいほど敏感）
  <input type="range" id="sensitivity" min="5" max="100" value="30" />
</label>
<button id="startDetect">検知スタート</button>
<button id="stopDetect">停止</button>
</div>

  <div class="box">
    <h2>ログ</h2>
    <div id="log"></div>
  </div>

<script>
let sounds = [];        // 登録された音
let learnedPatterns = {}; // 保存された動作パターン
let currentLearning = []; // 今記録中のモーション
let isLearning = false;
let isDetecting = false;
let lastMotion = null;

// ロード（localStorage）
window.onload = () => {
  const saved = localStorage.getItem('motionPatterns');
  if (saved) learnedPatterns = JSON.parse(saved);
  refreshPatternList();
};

function log(msg){
  document.getElementById('log').textContent += msg + "
";
}

// 1. 音追加 ---------------------------------------
document.getElementById('addSoundBtn').onclick = () => {
  const file = document.getElementById('soundFile').files[0];
  if (!file) return alert('音ファイルを選んでください');

  const url = URL.createObjectURL(file);
  const audio = new Audio(url);
  sounds.push(audio);
  document.getElementById('soundCount').textContent = sounds.length;
  log('音を登録しました');
};

function playSound(){
  if (sounds.length === 0) return;
  // すべての音を同時に鳴らす
  sounds.forEach(a => {
    const s = new Audio(a.src);
    s.currentTime = 0;
    s.play();
  });
}

// 2. 動作の学習 ---------------------------------------
document.getElementById('startLearn').onclick = () => {
  currentLearning = [];
  isLearning = true;
  log('学習開始');
};

document.getElementById('stopLearn').onclick = () => {
  if (!isLearning) return;
  isLearning = false;

  const name = document.getElementById('patternName').value;
  if (!name) return alert('パターン名を入れてください');

  learnedPatterns[name] = currentLearning;
  localStorage.setItem('motionPatterns', JSON.stringify(learnedPatterns));
  refreshPatternList();
  log('学習終了: ' + name);
};

// 3. パターン一覧 ---------------------------------------
function refreshPatternList(){
  const list = document.getElementById('patternList');
  list.innerHTML = '';
  Object.keys(learnedPatterns).forEach(name => {
    const op = document.createElement('option');
    op.value = name;
    op.textContent = name;
    list.appendChild(op);
  });
}

document.getElementById('deletePattern').onclick = () => {
  const list = document.getElementById('patternList');
  const name = list.value;
  if (!name) return;
  delete learnedPatterns[name];
  localStorage.setItem('motionPatterns', JSON.stringify(learnedPatterns));
  refreshPatternList();
  log('削除: ' + name);
};

// 4. iPhoneモーション検知 ---------------------------------------
window.addEventListener('deviceorientation', (e)=>{
  const data = { alpha:e.alpha, beta:e.beta, gamma:e.gamma, t:Date.now() };

  if (isLearning) {
    currentLearning.push(data);
  }

  if (isDetecting) {
    detectMotion(data);
  }
});

function detectMotion(current){
  let best = null;
  let bestScore = 999999;

  Object.keys(learnedPatterns).forEach(name => {
    const pattern = learnedPatterns[name];
    if (pattern.length === 0) return;

    const dx = current.alpha - pattern[0].alpha;
    const dy = current.beta - pattern[0].beta;
    const dz = current.gamma - pattern[0].gamma;

    const score = Math.abs(dx) + Math.abs(dy) + Math.abs(dz);

    if (score < bestScore) {
      bestScore = score;
      best = name;
    }
  });

  const threshold = Number(document.getElementById('sensitivity').value);
  if (best && bestScore < threshold) { // 閾値
    log('検知: ' + best);
    playSound();
  }
}

document.getElementById('startDetect').onclick = ()=>{
  isDetecting = true;
  log('検知開始');
};

document.getElementById('stopDetect').onclick = ()=>{
  isDetecting = false;
  log('検知停止');
};
</script>
</body>
</html>
