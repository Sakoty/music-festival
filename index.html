<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>iPhone Motion → Sound</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  button { padding: 12px 20px; font-size: 16px; margin: 10px 0; }
  .status { margin-top: 20px; }
</style>
</head>
<body>

<h2>iPhone 動作検知 → 音を鳴らすデモ</h2>

<button id="permBtn">動きセンサーの許可を与える</button><br>
<button id="startBtn" disabled>開始</button>
<p class="status" id="status">ステータス: 待機中</p>

<script>
let audioCtx;
let gain;
let threshold = 2.0; // 加速度の変化量のしきい値（好きに調整）

function initAudio() {
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  gain = audioCtx.createGain();
  gain.gain.value = 0.3;
  gain.connect(audioCtx.destination);
}

function playBeep() {
  const osc = audioCtx.createOscillator();
  osc.type = "sine";
  osc.frequency.value = 880;
  osc.connect(gain);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.2);
}

document.getElementById("permBtn").onclick = async () => {
  // iPhone の動きセンサー許可
  if (typeof DeviceMotionEvent.requestPermission === "function") {
    const res = await DeviceMotionEvent.requestPermission();
    if (res === "granted") {
      document.getElementById("status").textContent = "許可されました。開始できます。";
      document.getElementById("startBtn").disabled = false;
    } else {
      alert("センサーの許可が必要です。");
    }
  } else {
    alert("このブラウザは iPhone 動きセンサー許可APIに対応していません。");
  }
};

document.getElementById("startBtn").onclick = () => {
  if (!audioCtx) initAudio();

  document.getElementById("status").textContent = "動き検知中…";

  window.addEventListener("devicemotion", (e) => {
    const ax = e.accelerationIncludingGravity.x || 0;
    const ay = e.accelerationIncludingGravity.y || 0;
    const az = e.accelerationIncludingGravity.z || 0;

    const total = Math.sqrt(ax*ax + ay*ay + az*az);

    if (total > threshold) {
      playBeep();
      document.getElementById("status").textContent = "動きを検知！ (" + total.toFixed(2) + ")";
    }
  });
};
</script>

</body>
</html>
