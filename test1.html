<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Motion Sound — 完全版（安定動作）</title>

<style>
:root{--bg:#fff;--card:#f8f9fb;--muted:#666;--accent:#0b84ff}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,"Noto Sans JP";margin:0;background:var(--bg);color:#111}
.wrap{max-width:960px;margin:18px auto;padding:18px}
h1{font-size:20px;margin:0 0 12px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
.card{background:#fff;border:1px solid #e6e9ef;padding:14px;border-radius:10px}
.controls{display:flex;gap:8px;flex-wrap:wrap}
button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;font-weight:600}
button.ghost{background:#eee;color:#222}
label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd}
#log{height:120px;overflow:auto;background:#0f1724;color:#d1d5db;padding:8px;border-radius:8px;font-family:monospace;font-size:12px}
canvas{width:100%;height:120px;background:#0b1220;border-radius:6px}
ul{list-style:none;padding:0;margin:0}
li{padding:6px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;gap:6px}
.smallbtn{padding:4px 6px;border-radius:6px;border:1px solid #ccc;background:#fff}
.badge{padding:4px 8px;border-radius:8px;background:#e5e7eb;font-size:12px}
.progress{height:8px;background:#eee;border-radius:6px;overflow:hidden}
.progress i{display:block;height:100%;width:0;background:var(--accent)}
</style>
</head>

<body>
<div class="wrap">
<h1>Motion Sound — 完全版（安定動作）</h1>

<div class="grid">
<!-- ================= 左 ================= -->
<div class="card">

<h3>① 準備</h3>
<div class="controls">
<button id="initBtn">開始（必ず最初にタップ）</button>
<button id="startBtn" class="ghost" disabled>検知開始</button>
<button id="stopBtn" class="ghost" disabled>停止</button>
</div>

<hr>

<h3>② 音源登録</h3>
<input type="file" id="fileInput" multiple accept="audio/*">
<select id="motionSelect">
<option value="shake">シェイク</option>
<option value="x">X軸</option>
<option value="y">Y軸</option>
<option value="z">Z軸</option>
<option value="learned">学習</option>
</select>
<button id="addFileBtn">登録</button>

<ul id="soundList"></ul>

<hr>

<h3>③ 感度</h3>
<label>シェイク<input type="range" id="shakeTh" min="2" max="10" step="0.1" value="4"></label>
<label>軸<input type="range" id="axisTh" min="1" max="6" step="0.1" value="2"></label>
<label>学習<input type="range" id="matchTh" min="0.5" max="8" step="0.1" value="2.5"></label>
<label>音量<input type="range" id="vol" min="0" max="1" step="0.01" value="0.8"></label>

<hr>

<h3>④ モーション学習</h3>
<input id="patternName" placeholder="パターン名">
<div class="controls">
<button id="learnBtn">学習開始（3秒）</button>
<span class="badge" id="learnState">待機</span>
</div>
<div class="progress"><i id="learnProg"></i></div>
<div id="learnInfo" class="badge">記録数: 0</div>
<canvas id="learnViz"></canvas>
<button id="savePattern" class="ghost">保存</button>

<h4>保存済み</h4>
<ul id="patternList"></ul>

</div>

<!-- ================= 右 ================= -->
<div class="card">
<div id="status">待機</div>
<canvas id="viz"></canvas>
<div id="log"></div>
</div>

</div>
</div>

<script>
/* ========= Audio ========= */
let audioCtx=null, masterGain=null;
const sounds={shake:[],x:[],y:[],z:[],learned:[]};

function initAudio(){
 if(audioCtx) return;
 audioCtx=new (window.AudioContext||window.webkitAudioContext)();
 masterGain=audioCtx.createGain();
 masterGain.gain.value=document.getElementById('vol').value;
 masterGain.connect(audioCtx.destination);
}

async function unlockAudio(){
 initAudio();
 if(audioCtx.state!=='running') await audioCtx.resume();
 const b=audioCtx.createBuffer(1,1,audioCtx.sampleRate);
 const s=audioCtx.createBufferSource();
 s.buffer=b; s.connect(masterGain); s.start();
 log('Audio unlocked');
}

function play(buf){
 if(!buf) return;
 if(audioCtx.state!=='running') audioCtx.resume();
 const s=audioCtx.createBufferSource();
 s.buffer=buf; s.connect(masterGain); s.start();
}

/* ========= Utils ========= */
const logEl=id=>document.getElementById(id);
function log(t){logEl('log').innerHTML=`${new Date().toLocaleTimeString()} ${t}<br>`+logEl('log').innerHTML;}
function status(t){logEl('status').textContent=`状態: ${t} / Audio:${audioCtx?audioCtx.state:'none'}`}

/* ========= Sound Register ========= */
logEl('addFileBtn').onclick=async()=>{
 initAudio();
 for(const f of logEl('fileInput').files){
  const ab=await f.arrayBuffer();
  const buf=await audioCtx.decodeAudioData(ab);
  sounds[logEl('motionSelect').value].push(buf);
  log(`登録 ${f.name}`);
 }
 renderSounds();
}

function renderSounds(){
 const ul=logEl('soundList'); ul.innerHTML='';
 for(const k in sounds){
  sounds[k].forEach((_,i)=>{
   const li=document.createElement('li');
   li.textContent=`${k}[${i}]`;
   const b=document.createElement('button');
   b.textContent='▶'; b.className='smallbtn';
   b.onclick=()=>play(sounds[k][i]);
   li.appendChild(b); ul.appendChild(li);
  });
 }
}

/* ========= Motion & Learning ========= */
let detecting=false, learning=false, learnData=[];
let vizBuf=[], lastTrig={};

function dtw(a,b){
 const n=a.length,m=b.length,inf=1e9;
 const d=Array(n+1).fill().map(()=>Array(m+1).fill(inf));
 d[0][0]=0;
 for(let i=1;i<=n;i++)for(let j=1;j<=m;j++)
  d[i][j]=Math.abs(a[i-1]-b[j-1])+Math.min(d[i-1][j],d[i][j-1],d[i-1][j-1]);
 return d[n][m]/(n+m);
}

window.addEventListener('devicemotion',e=>{
 if(!detecting) return;
 const a=e.accelerationIncludingGravity; if(!a) return;
 const t=Math.hypot(a.x,a.y,a.z);
 vizBuf.push(t); if(vizBuf.length>200) vizBuf.shift();

 if(learning) learnData.push(t);

 const now=Date.now();
 const cd=600;

 if(t>logEl('shakeTh').value && now-(lastTrig.s||0)>cd){
  lastTrig.s=now;
  if(sounds.shake[0]) play(sounds.shake[0]);
 }

 const pats=JSON.parse(localStorage.getItem('patterns')||'[]');
 if(pats.length){
  const cur=vizBuf.slice(-60);
  pats.forEach(p=>{
   if(dtw(cur,p.data)<logEl('matchTh').value){
    play(sounds.learned[p.sound]);
   }
  });
 }
});

/* ========= Learning ========= */
logEl('learnBtn').onclick=()=>{
 learning=true; learnData=[];
 logEl('learnState').textContent='学習中';
 let t=0;
 const iv=setInterval(()=>{
  t+=100;
  logEl('learnProg').style.width=`${t/30}%`;
  logEl('learnInfo').textContent=`記録数:${learnData.length}`;
  if(t>=3000){
   clearInterval(iv); learning=false;
   logEl('learnState').textContent='完了';
  }
 },100);
}

logEl('savePattern').onclick=()=>{
 const name=logEl('patternName').value;
 if(!name||learnData.length<10) return;
 const pats=JSON.parse(localStorage.getItem('patterns')||'[]');
 pats.push({name,data:learnData.slice(-60),sound:0});
 localStorage.setItem('patterns',JSON.stringify(pats));
 renderPatterns();
}

function renderPatterns(){
 const ul=logEl('patternList'); ul.innerHTML='';
 const pats=JSON.parse(localStorage.getItem('patterns')||'[]');
 pats.forEach(p=>{
  const li=document.createElement('li');
  li.textContent=p.name; ul.appendChild(li);
 });
}

/* ========= Buttons ========= */
logEl('initBtn').onclick=async()=>{
 await unlockAudio();
 if(DeviceMotionEvent?.requestPermission){
  const r=await DeviceMotionEvent.requestPermission();
  if(r!=='granted') return alert('許可が必要');
 }
 logEl('startBtn').disabled=false;
 status('準備完了');
}

logEl('startBtn').onclick=async()=>{
 await unlockAudio();
 detecting=true;
 logEl('startBtn').disabled=true;
 logEl('stopBtn').disabled=false;
 status('検知中');
}

logEl('stopBtn').onclick=()=>{
 detecting=false;
 logEl('startBtn').disabled=false;
 logEl('stopBtn').disabled=true;
 status('停止');
}

logEl('vol').oninput=e=>{ if(masterGain) masterGain.gain.value=e.target.value }

renderPatterns();
</script>
</body>
</html>
