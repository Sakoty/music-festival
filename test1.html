<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Motion Sound â€” å­¦ç¿’ä¿å­˜ & å€‹åˆ¥éŸ³</title>
<style>
body{font-family:system-ui;margin:0;background:#fff}
.wrap{max-width:900px;margin:auto;padding:16px}
.card{border:1px solid #ddd;border-radius:10px;padding:14px;margin-bottom:14px}
button{background:#0b84ff;color:#fff;border:0;border-radius:8px;padding:8px 12px;font-weight:600}
button.ghost{background:#eee;color:#111}
input,select{width:100%;padding:6px;margin-top:6px}
canvas{width:100%;height:80px;background:#081017;border-radius:6px}
.list li{border-bottom:1px solid #eee;padding:6px 0}
#log{background:#000;color:#0f0;height:120px;overflow:auto;font-size:12px;padding:6px}
</style>
</head>
<body>
<div class="wrap">

<h2>Motion Soundï¼ˆå­¦ç¿’ä¿å­˜ & å€‹åˆ¥éŸ³ï¼‰</h2>

<div class="card">
<button id="initBtn">é–‹å§‹ï¼ˆè¨±å¯ï¼‰</button>
<button id="startDetectBtn" class="ghost" disabled>æ¤œçŸ¥é–‹å§‹</button>
<button id="stopDetectBtn" class="ghost" disabled>åœæ­¢</button>
<div id="status">å¾…æ©Ÿ</div>
</div>

<div class="card">
<h3>â‘  ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç¿’</h3>
<input id="patternName" placeholder="å‹•ãã®åå‰">
<button id="startLearn">å­¦ç¿’é–‹å§‹ï¼ˆ3ç§’ï¼‰</button>
<canvas id="preview"></canvas>
</div>

<div class="card">
<h3>â‘¡ éŸ³ã‚’å‰²ã‚Šå½“ã¦</h3>
<input type="file" id="soundFile" accept="audio/*">
<button id="savePattern">ä¿å­˜</button>
</div>

<div class="card">
<h3>ä¿å­˜æ¸ˆã¿ãƒ‘ã‚¿ãƒ¼ãƒ³</h3>
<ul id="patternList" class="list"></ul>
</div>

<div class="card">
<h3>ãƒ­ã‚°</h3>
<div id="log"></div>
</div>

<script>
/* ===== Audio ===== */
let audioCtx;
function initAudio(){
 if(!audioCtx){
  audioCtx=new (AudioContext||webkitAudioContext)();
 }
}
function decode(ab){
 return audioCtx.decodeAudioData(ab.slice(0));
}
function play(buf){
 if(audioCtx.state==='suspended') audioCtx.resume();
 const s=audioCtx.createBufferSource();
 s.buffer=buf;
 s.connect(audioCtx.destination);
 s.start();
}

/* ===== State ===== */
let isDetecting=false,isLearning=false;
let learnBuf=[];
let patterns=[];

/* ===== Storage ===== */
function load(){
 patterns=JSON.parse(localStorage.getItem('motionPatterns')||'[]');
 renderList();
}
function save(){
 localStorage.setItem('motionPatterns',JSON.stringify(patterns));
}

/* ===== Utils ===== */
function resample(a,n){
 return [...Array(n)].map((_,i)=>{
  const t=i*(a.length-1)/(n-1);
  const lo=Math.floor(t),hi=Math.ceil(t);
  return lo===hi?a[lo]:a[lo]*(hi-t)+a[hi]*(t-lo);
 });
}
function dtw(a,b){
 const n=a.length,m=b.length;
 const D=[...Array(n+1)].map(()=>Array(m+1).fill(1e9));
 D[0][0]=0;
 for(let i=1;i<=n;i++)
  for(let j=1;j<=m;j++)
   D[i][j]=Math.abs(a[i-1]-b[j-1])+Math.min(D[i-1][j],D[i][j-1],D[i-1][j-1]);
 return D[n][m]/(n+m);
}

/* ===== Learning ===== */
document.getElementById('startLearn').onclick=()=>{
 learnBuf=[];
 isLearning=true;
 setTimeout(()=>{isLearning=false;draw(learnBuf)},3000);
};

document.getElementById('savePattern').onclick=async()=>{
 const name=patternName.value.trim();
 if(!name||learnBuf.length<10){alert('å­¦ç¿’ä¸è¶³');return;}
 const file=soundFile.files[0];
 if(!file){alert('éŸ³ã‚’é¸æŠ');return;}
 initAudio();
 const buf=await decode(await file.arrayBuffer());
 patterns.push({
  id:Date.now(),
  name,
  data:resample(learnBuf,60),
  sound:{name:file.name,buf}
 });
 save(); renderList(); log('ä¿å­˜:'+name);
};

/* ===== Motion ===== */
window.addEventListener('devicemotion',e=>{
 const a=e.accelerationIncludingGravity;
 if(!a)return;
 const v=Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z);
 if(isLearning) learnBuf.push(v);
 if(!isDetecting||patterns.length===0)return;

 const cand=resample(learnBuf.slice(-240),60);
 patterns.forEach(p=>{
  if(dtw(cand,p.data)<2.5){
   play(p.sound.buf);
   log('æ¤œçŸ¥:'+p.name);
  }
 });
});

/* ===== UI ===== */
initBtn.onclick=async()=>{
 initAudio();
 if(DeviceMotionEvent?.requestPermission){
  if(await DeviceMotionEvent.requestPermission()!=='granted'){alert('è¨±å¯å¿…è¦');return;}
 }
 startDetectBtn.disabled=false;
 log('æº–å‚™å®Œäº†');
};
startDetectBtn.onclick=()=>{isDetecting=true;};
stopDetectBtn.onclick=()=>{isDetecting=false;};

function renderList(){
 patternList.innerHTML='';
 patterns.forEach(p=>{
  const li=document.createElement('li');
  li.textContent=`${p.name} ğŸ”Š${p.sound.name}`;
  patternList.appendChild(li);
 });
}
function draw(a){
 const c=preview,ctx=c.getContext('2d');
 c.width=c.clientWidth*devicePixelRatio;
 c.height=c.clientHeight*devicePixelRatio;
 ctx.strokeStyle='#0f0';ctx.beginPath();
 a.forEach((v,i)=>{
  const x=i*c.width/(a.length-1);
  const y=c.height-v*10;
  i?ctx.lineTo(x,y):ctx.moveTo(x,y);
 });
 ctx.stroke();
}
function log(t){logDiv.innerHTML=t+'<br>'+logDiv.innerHTML;}

const logDiv=document.getElementById('log');
load();
</script>
</div>
</body>
</html>
