<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Motion Sound â€” å®Œå…¨çµ±åˆç‰ˆï¼ˆå­¦ç¿’æ”¹å–„ï¼‰</title>
<style>
:root{--bg:#fff;--card:#f8f9fb;--muted:#666;--accent:#0b84ff}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,"Noto Sans JP";margin:0;background:var(--bg);color:#111}
.wrap{max-width:920px;margin:18px auto;padding:18px}
h1{font-size:20px;margin:0 0 12px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
.card{background:#fff;border:1px solid #e6e9ef;padding:14px;border-radius:10px;box-shadow:0 2px 6px rgba(12,12,12,0.03)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
button.ghost{background:#eee;color:#222}
label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
input[type=range]{width:100%}
select,input[type=text],input[type=file]{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd}
small{color:var(--muted)}
#log{height:120px;overflow:auto;background:#0f1724;color:#d1d5db;padding:8px;border-radius:8px;font-family:monospace;font-size:12px}
ul.list{list-style:none;padding:0;margin:8px 0}
ul.list li{padding:8px;border-bottom:1px solid #f1f3f5;display:flex;justify-content:space-between;gap:8px;align-items:center}
.muted{color:var(--muted)}
canvas#viz{width:100%;height:120px;background:#0b1220;border-radius:6px}
.smallbtn{background:#fff;border:1px solid #e6e9ef;padding:6px 8px;color:#222;border-radius:6px}
.footer{margin-top:12px;font-size:12px;color:var(--muted)}

/* --- æ–°UI: å­¦ç¿’çŠ¶æ…‹è¡¨ç¤º --- */
.learn-ui { margin-top:8px; display:flex; gap:8px; align-items:center; }
.progress { height:10px; background:#eee; border-radius:6px; overflow:hidden; width:100%; }
.progress > i { display:block; height:100%; width:0%; background:var(--accent); transition:width 0.12s linear; }
.badge { padding:4px 8px; border-radius:8px; background:#f1f5f9; color:#111; font-size:13px; }
.pattern-preview { width:100%; height:56px; background:#081017; border-radius:6px; margin-top:8px; }
.pattern-meta { font-size:12px; color:var(--muted); margin-top:6px; }
</style>
</head>
<body>
<div class="wrap">
<h1>Motion Sound â€” å®Œå…¨çµ±åˆç‰ˆï¼ˆå­¦ç¿’æ”¹å–„ï¼‰</h1>
<div class="grid">
  <div class="card">
    <h3>æº–å‚™ & è¨±å¯</h3>
    <div class="controls">
      <button id="initBtn">é–‹å§‹ï¼ˆã‚¿ãƒƒãƒ—ã—ã¦è¨±å¯ï¼‰</button>
      <button id="startDetectBtn" class="ghost" disabled>æ¤œçŸ¥ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="stopDetectBtn" class="ghost" disabled>æ¤œçŸ¥åœæ­¢</button>
    </div>
    <p class="muted">iPhone ã¯å¿…ãšã‚¿ãƒƒãƒ—å†…ã§è¨±å¯ãŒå¿…è¦ã€‚</p>

    <hr/>

    <h3>éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè¤‡æ•°å¯ / ãƒ­ãƒ¼ã‚«ãƒ«ï¼‰</h3>
    <input id="fileInput" type="file" accept="audio/*" multiple>
    <label>å¤–éƒ¨éŸ³æºURL<input id="urlInput" type="text" placeholder="ä¾‹: https://.../sound.mp3"></label>
    <button id="addUrlBtn">URLç™»éŒ²</button>

    <select id="motionSelect">
      <option value="shake">å¼·ã„ã‚·ã‚§ã‚¤ã‚¯</option>
      <option value="x">å·¦å³(X)</option>
      <option value="y">ä¸Šä¸‹(Y)</option>
      <option value="z">å‰å¾Œ(Z)</option>
      <option value="learned">å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³</option>
    </select>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="assignFiles">ç™»éŒ²</button>
      <button id="clearMotionSounds" class="ghost">é¸æŠãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã®éŸ³ã‚’ã‚¯ãƒªã‚¢</button>
    </div>
    <p id="assignMsg" class="muted"></p>

    <hr/>

    <h3>ç™»éŒ²éŸ³ä¸€è¦§</h3>
    <ul id="soundLists" class="list"></ul>

    <hr/>

    <h3>æ„Ÿåº¦ãƒ»è¨­å®š</h3>
    <label>ã‚·ã‚§ã‚¤ã‚¯é–¾å€¤<input id="shakeThresh" type="range" min="1.5" max="10" step="0.1" value="4"></label>
    <label>è»¸é–¾å€¤<input id="axisThresh" type="range" min="0.5" max="6" step="0.1" value="2"></label>
    <label>å­¦ç¿’ãƒãƒƒãƒé–¾å€¤<input id="matchThresh" type="range" min="0.1" max="10" step="0.1" value="2.5"></label>
    <label>ãƒˆãƒªã‚¬ãƒ¼å†·å´(ms)<input id="cooldown" type="range" min="200" max="5000" step="100" value="800"></label>
    <label>ãƒã‚¹ã‚¿ãƒ¼éŸ³é‡<input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.8"></label>

    <hr/>

    <h3>ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç¿’</h3>
    <label>ãƒ‘ã‚¿ãƒ¼ãƒ³å <input id="patternName" type="text" placeholder="ä¾‹: 2å›ç¸¦ã«æŒ¯ã‚‹"></label>
    <label>å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ç”¨ã®éŸ³ 
      <select id="learnSoundSelect"></select>
    </label>

    <div class="learn-ui">
      <button id="startLearn">å­¦ç¿’é–‹å§‹ï¼ˆ3ç§’ï¼‰</button>
      <div class="progress" title="å­¦ç¿’é€²æ—"><i id="learnProgress"></i></div>
      <div class="badge" id="learnState">å¾…æ©Ÿ</div>
    </div>

    <div class="pattern-meta" id="learnInfo">è¨˜éŒ²æ•°: 0</div>
    <canvas id="patternPreview" class="pattern-preview"></canvas>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="savePattern" class="ghost">ä¿å­˜</button>
      <button id="testPattern" class="ghost">ãƒ†ã‚¹ãƒˆå†ç”Ÿ</button>
    </div>

    <hr/>
    <h3>ä¿å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³</h3>
    <ul id="patternList" class="list"></ul>
  </div>

  <div class="card">
    <h3>çŠ¶æ…‹</h3>
    <div id="status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: å¾…æ©Ÿä¸­</div>
    <h4>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¯è¦–åŒ–</h4>
    <canvas id="viz"></canvas>
    <h4>ãƒ­ã‚°</h4>
    <div id="log"></div>
    <div class="footer">ãƒ’ãƒ³ãƒˆ: iPhoneã¯ç”»é¢ã‚¿ãƒƒãƒ—å†…ã§ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
  </div>
</div>
</div>

<script>
/* =========================================================
   Motion Sound System â€” JS å®Œå…¨ç‰ˆï¼ˆä¿å­˜å¯¾å¿œï¼‰
   ========================================================= */

/* ---------- å®šæ•° ---------- */
const STORAGE_KEY = 'motionSoundPatterns_v1';
const SAMPLE_INTERVAL_MS = 25;
const LEARN_DURATION_MS = 3000;

/* ---------- Audio ---------- */
let audioCtx = null;
const master = { gainNode: null, vol: 0.8 };

/* ---------- çŠ¶æ…‹ ---------- */
let isDetecting = false;
let isLearning = false;
let learnStartAt = 0;
let lastSampleTime = 0;
let currentLearn = [];
let vizBuffer = [];
let lastTriggeredAt = {};

/* ---------- ãƒ‡ãƒ¼ã‚¿ ---------- */
const soundMap = { shake: [], x: [], y: [], z: [], learned: [] };

/* ---------- Audio åˆæœŸåŒ– ---------- */
function initAudioIfNeeded(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  master.gainNode = audioCtx.createGain();
  master.gainNode.gain.value = master.vol;
  master.gainNode.connect(audioCtx.destination);

  document.addEventListener('touchstart', ()=>audioCtx.resume(), { once:true });
  document.addEventListener('click', ()=>audioCtx.resume(), { once:true });

  log('AudioContext åˆæœŸåŒ–');
}

/* ---------- Audio Decode å®‰å®šåŒ– ---------- */
function decodeAudioSafe(arrayBuffer){
  initAudioIfNeeded();
  return new Promise((resolve,reject)=>{
    try{
      const p = audioCtx.decodeAudioData(
        arrayBuffer.slice(0),
        buf=>resolve(buf),
        err=>reject(err)
      );
      if(p && p.then) p.then(resolve).catch(reject);
    }catch(e){ reject(e); }
  });
}

/* ---------- å†ç”Ÿ ---------- */
function playBuffer(buf){
  if(!buf) return;
  if(audioCtx.state === 'suspended') audioCtx.resume();
  const src = audioCtx.createBufferSource();
  src.buffer = buf;
  src.connect(master.gainNode);
  src.start();
}

/* ---------- ä¿å­˜ç”¨ Audio å¤‰æ› ---------- */
function serializeAudioBuffer(buf){
  return {
    sampleRate: buf.sampleRate,
    data: Array.from(buf.getChannelData(0))
  };
}

function restoreAudioBuffer(saved){
  initAudioIfNeeded();
  const buf = audioCtx.createBuffer(
    1,
    saved.audio.data.length,
    saved.audio.sampleRate
  );
  buf.getChannelData(0).set(saved.audio.data);
  return buf;
}

/* ---------- DTW ---------- */
function dtwDistance(a,b){
  const n=a.length, m=b.length;
  const INF=1e9;
  const D = Array.from({length:n+1},()=>Array(m+1).fill(INF));
  D[0][0]=0;
  for(let i=1;i<=n;i++){
    for(let j=1;j<=m;j++){
      const cost=Math.abs(a[i-1]-b[j-1]);
      D[i][j]=cost+Math.min(D[i-1][j],D[i][j-1],D[i-1][j-1]);
    }
  }
  return D[n][m]/(n+m);
}

/* ---------- ãƒªã‚µãƒ³ãƒ—ãƒ« ---------- */
function resample(arr,target){
  if(arr.length===0) return Array(target).fill(0);
  const out=[];
  for(let i=0;i<target;i++){
    const t=i*(arr.length-1)/(target-1);
    const lo=Math.floor(t), hi=Math.ceil(t);
    out.push(lo===hi?arr[lo]:arr[lo]*(hi-t)+arr[hi]*(t-lo));
  }
  return out;
}

/* ---------- å­¦ç¿’é–‹å§‹ ---------- */
startLearn.onclick = ()=>{
  if(isLearning) return;
  currentLearn=[];
  isLearning=true;
  learnStartAt=Date.now();
  lastSampleTime=0;
  learnState.textContent='éŒ²éŸ³ä¸­';
  learnProgress.style.width='0%';
  log('å­¦ç¿’é–‹å§‹');

  const timer=setInterval(()=>{
    const p=(Date.now()-learnStartAt)/LEARN_DURATION_MS*100;
    learnProgress.style.width=Math.min(p,100)+'%';
    if(p>=100){
      clearInterval(timer);
      isLearning=false;
      learnState.textContent='å®Œäº†';
      log(`å­¦ç¿’å®Œäº† (${currentLearn.length})`);
    }
  },50);
};

/* ---------- ä¿å­˜ ---------- */
savePattern.onclick = ()=>{
  const name = patternName.value.trim();
  if(!name || currentLearn.length<12){
    alert('å­¦ç¿’ä¸è¶³');
    return;
  }
  const sel = learnSoundSelect.value;
  if(!sel){ alert('éŸ³ã‚’é¸æŠ'); return; }

  const [motion, idx] = sel.split('|');
  const src = soundMap[motion][idx];

  const data = {
    name,
    motion: resample(currentLearn,60),
    audio: serializeAudioBuffer(src.buf),
    audioName: src.name,
    created: Date.now()
  };

  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
  saved.push(data);
  localStorage.setItem(STORAGE_KEY,JSON.stringify(saved));
  refreshPatternList();
  log(`ä¿å­˜: ${name}`);
};

/* ---------- å†ç”Ÿ ---------- */
function playPatternSound(p){
  const buf = restoreAudioBuffer(p);
  playBuffer(buf);
}

/* ---------- Pattern List ---------- */
function refreshPatternList(){
  patternList.innerHTML='';
  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
  saved.forEach((p,i)=>{
    const li=document.createElement('li');
    li.innerHTML=`<strong>${p.name}</strong><small>${p.audioName}</small>`;
    const btn=document.createElement('button');
    btn.textContent='â–¶';
    btn.onclick=()=>playPatternSound(p);
    li.appendChild(btn);
    patternList.appendChild(li);
  });
}

/* ---------- DeviceMotion ---------- */
window.addEventListener('devicemotion',e=>{
  const a=e.accelerationIncludingGravity;
  if(!a) return;
  const t=Math.sqrt(a.x*a.x+a.y*a.y+a.z*a.z);
  vizBuffer.push(t);
  if(vizBuffer.length>240) vizBuffer.shift();

  const now=Date.now();

  if(isLearning){
    if(now-lastSampleTime>SAMPLE_INTERVAL_MS){
      currentLearn.push(t);
      lastSampleTime=now;
    }
    return;
  }

  if(!isDetecting) return;

  const saved = JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
  if(saved.length===0) return;

  const candidate=resample(vizBuffer.slice(-240),60);
  let best=null,bestScore=Infinity;
  saved.forEach(p=>{
    const s=dtwDistance(candidate,p.motion);
    if(s<bestScore){bestScore=s;best=p;}
  });

  if(best && bestScore<Number(matchThresh.value)){
    if(now-(lastTriggeredAt.learned||0)>Number(cooldown.value)){
      lastTriggeredAt.learned=now;
      playPatternSound(best);
      status(`æ¤œå‡º: ${best.name}`);
    }
  }
});

/* ---------- è¨±å¯ ---------- */
initBtn.onclick=async()=>{
  initAudioIfNeeded();
  if(DeviceMotionEvent.requestPermission){
    const r=await DeviceMotionEvent.requestPermission();
    if(r==='granted'){
      startDetectBtn.disabled=false;
      status('è¨±å¯OK');
    }
  }else{
    startDetectBtn.disabled=false;
  }
};

/* ---------- æ¤œçŸ¥ON/OFF ---------- */
startDetectBtn.onclick=()=>{
  isDetecting=true;
  startDetectBtn.disabled=true;
  stopDetectBtn.disabled=false;
  status('æ¤œçŸ¥ä¸­');
};
stopDetectBtn.onclick=()=>{
  isDetecting=false;
  startDetectBtn.disabled=false;
  stopDetectBtn.disabled=true;
  status('åœæ­¢');
};

/* ---------- ãƒ­ã‚° ---------- */
function log(t){
  const l=document.getElementById('log');
  l.innerHTML=`[${new Date().toLocaleTimeString()}] ${t}<br>`+l.innerHTML;
}
function status(t){
  document.getElementById('status').textContent='ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: '+t;
}

/* ---------- åˆæœŸå¾©å…ƒ ---------- */
window.addEventListener('load',()=>{
  refreshPatternList();
});

  /* =========================================================
   ğŸ”Š éŸ³ãƒ•ã‚¡ã‚¤ãƒ«ç™»éŒ²å‡¦ç†ï¼ˆæ¬ ã‘ã¦ã„ãŸéƒ¨åˆ†ï¼‰
   ========================================================= */

const fileInput = document.getElementById('fileInput');
const motionSelect = document.getElementById('motionSelect');

fileInput.addEventListener('change', async () => {
  const files = Array.from(fileInput.files || []);
  if (files.length === 0) return;

  initAudioIfNeeded();

  const motion = motionSelect.value;

  for (const file of files) {
    try {
      const arrayBuffer = await file.arrayBuffer();
      const audioBuffer = await decodeAudioSafe(arrayBuffer);

      if (!audioBuffer) {
        log(`ãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•—: ${file.name}`);
        continue;
      }

      soundMap[motion].push({
        name: file.name,
        buf: audioBuffer
      });

      log(`éŸ³ç™»éŒ²æˆåŠŸ: ${file.name} â†’ ${motion}`);
    } catch (e) {
      console.error(e);
      log(`éŸ³ç™»éŒ²ã‚¨ãƒ©ãƒ¼: ${file.name}`);
    }
  }

  // UIæ›´æ–°
  refreshLearnSoundSelect();
  refreshSoundLists();

  // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†é¸æŠã§ãã‚‹ã‚ˆã†ã«ã‚¯ãƒªã‚¢
  fileInput.value = '';
});
</script>
</body>
</html>
