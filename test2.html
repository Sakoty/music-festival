<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Motion Sound — 完全統合版（学習改善）</title>
<style>
:root{--bg:#fff;--card:#f8f9fb;--muted:#666;--accent:#0b84ff}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",Meiryo,"Noto Sans JP";margin:0;background:var(--bg);color:#111}
.wrap{max-width:920px;margin:18px auto;padding:18px}
h1{font-size:20px;margin:0 0 12px}
.grid{display:grid;grid-template-columns:1fr 360px;gap:14px}
.card{background:#fff;border:1px solid #e6e9ef;padding:14px;border-radius:10px;box-shadow:0 2px 6px rgba(12,12,12,0.03)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
button{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
button.ghost{background:#eee;color:#222}
label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
input[type=range]{width:100%}
select,input[type=text],input[type=file]{width:100%;padding:8px;border-radius:8px;border:1px solid #ddd}
small{color:var(--muted)}
#log{height:120px;overflow:auto;background:#0f1724;color:#d1d5db;padding:8px;border-radius:8px;font-family:monospace;font-size:12px}
ul.list{list-style:none;padding:0;margin:8px 0}
ul.list li{padding:8px;border-bottom:1px solid #f1f3f5;display:flex;justify-content:space-between;gap:8px;align-items:center}
.muted{color:var(--muted)}
canvas#viz{width:100%;height:120px;background:#0b1220;border-radius:6px}
.smallbtn{background:#fff;border:1px solid #e6e9ef;padding:6px 8px;color:#222;border-radius:6px}
.footer{margin-top:12px;font-size:12px;color:var(--muted)}

/* --- 新UI: 学習状態表示 --- */
.learn-ui { margin-top:8px; display:flex; gap:8px; align-items:center; }
.progress { height:10px; background:#eee; border-radius:6px; overflow:hidden; width:100%; }
.progress > i { display:block; height:100%; width:0%; background:var(--accent); transition:width 0.12s linear; }
.badge { padding:4px 8px; border-radius:8px; background:#f1f5f9; color:#111; font-size:13px; }
.pattern-preview { width:100%; height:56px; background:#081017; border-radius:6px; margin-top:8px; }
.pattern-meta { font-size:12px; color:var(--muted); margin-top:6px; }
</style>
</head>
<body>
<div class="wrap">
<h1>Motion Sound — 完全統合版（学習改善）</h1>
<div class="grid">
  <div class="card">
    <h3>準備 & 許可</h3>
    <div class="controls">
      <button id="initBtn">開始（タップして許可）</button>
      <button id="startDetectBtn" class="ghost" disabled>検知スタート</button>
      <button id="stopDetectBtn" class="ghost" disabled>検知停止</button>
    </div>
    <p class="muted">iPhone は必ずタップ内で許可が必要。</p>

    <hr/>

    <h3>音ファイル（複数可 / ローカル）</h3>
    <input id="fileInput" type="file" accept="audio/*" multiple>
    <label>外部音源URL<input id="urlInput" type="text" placeholder="例: https://.../sound.mp3"></label>
    <button id="addUrlBtn">URL登録</button>

    <select id="motionSelect">
      <option value="shake">強いシェイク</option>
      <option value="x">左右(X)</option>
      <option value="y">上下(Y)</option>
      <option value="z">前後(Z)</option>
      <option value="learned">学習パターン</option>
    </select>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="assignFiles">登録</button>
      <button id="clearMotionSounds" class="ghost">選択モーションの音をクリア</button>
    </div>
    <p id="assignMsg" class="muted"></p>

    <hr/>

    <h3>登録音一覧</h3>
    <ul id="soundLists" class="list"></ul>

    <hr/>

    <h3>感度・設定</h3>
    <label>シェイク閾値<input id="shakeThresh" type="range" min="1.5" max="10" step="0.1" value="4"></label>
    <label>軸閾値<input id="axisThresh" type="range" min="0.5" max="6" step="0.1" value="2"></label>
    <label>学習マッチ閾値<input id="matchThresh" type="range" min="0.1" max="10" step="0.1" value="2.5"></label>
    <label>トリガー冷却(ms)<input id="cooldown" type="range" min="200" max="5000" step="100" value="800"></label>
    <label>マスター音量<input id="masterVol" type="range" min="0" max="1" step="0.01" value="0.8"></label>

    <hr/>

    <h3>モーション学習</h3>
    <label>パターン名 <input id="patternName" type="text" placeholder="例: 2回縦に振る"></label>
    <label>学習パターン用の音 
      <select id="learnSoundSelect"></select>
    </label>

    <div class="learn-ui">
      <button id="startLearn">学習開始（3秒）</button>
      <div class="progress" title="学習進捗"><i id="learnProgress"></i></div>
      <div class="badge" id="learnState">待機</div>
    </div>

    <div class="pattern-meta" id="learnInfo">記録数: 0</div>
    <canvas id="patternPreview" class="pattern-preview"></canvas>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="savePattern" class="ghost">保存</button>
      <button id="testPattern" class="ghost">テスト再生</button>
    </div>

    <hr/>
    <h3>保存パターン</h3>
    <ul id="patternList" class="list"></ul>
  </div>

  <div class="card">
    <h3>状態</h3>
    <div id="status">ステータス: 待機中</div>
    <h4>リアルタイム可視化</h4>
    <canvas id="viz"></canvas>
    <h4>ログ</h4>
    <div id="log"></div>
    <div class="footer">ヒント: iPhoneは画面タップ内で「開始」を押してください。</div>
  </div>
</div>
</div>

<script>
/* =========================
   グローバル状態
   ========================= */
let audioCtx=null;
let isLearning=false;
let isDetecting=false;
let currentLearn=[];
let lastSampleTime=0;
let lastTriggeredAt={};
const SAMPLE_INTERVAL_MS=25;

const vizBuffer=[];
const master={gainNode:null,vol:0.8};

/* =========================
   Audio
   ========================= */
function initAudio(){
  if(audioCtx) return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  master.gainNode=audioCtx.createGain();
  master.gainNode.gain.value=master.vol;
  master.gainNode.connect(audioCtx.destination);
}

function playRawSound(savedSound){
  if(!savedSound) return;
  initAudio();
  const buf=audioCtx.createBuffer(
    1,
    savedSound.audioData.length,
    savedSound.sampleRate
  );
  buf.getChannelData(0).set(savedSound.audioData);
  const src=audioCtx.createBufferSource();
  src.buffer=buf;
  src.connect(master.gainNode);
  src.start();
}

/* =========================
   保存
   ========================= */
function savePattern(){
  const name=patternName.value.trim();
  if(!name||currentLearn.length<20){
    alert('学習不足');
    return;
  }

  const sel=learnSoundSelect.value;
  if(!sel){ alert('音を選択'); return; }

  const [motion,idx]=sel.split('|');
  const srcBuf=soundMap[motion][idx].buf;

  const audioData=new Float32Array(srcBuf.getChannelData(0));
  const pattern={
    name,
    data: resample(currentLearn,60),
    sound:{
      name:soundMap[motion][idx].name,
      audioData,
      sampleRate:srcBuf.sampleRate
    },
    created:Date.now()
  };

  const saved=JSON.parse(localStorage.getItem('motionPatterns')||'[]');
  saved.push(pattern);
  localStorage.setItem('motionPatterns',JSON.stringify(saved));
  refreshPatternList();
  log(`保存: ${name}`);
}

/* =========================
   DeviceMotion（統合）
   ========================= */
window.addEventListener('devicemotion',ev=>{
  const acc=ev.accelerationIncludingGravity||ev.acceleration;
  if(!acc) return;

  const total=Math.hypot(acc.x||0,acc.y||0,acc.z||0);
  vizBuffer.push(total);
  if(vizBuffer.length>240) vizBuffer.shift();
  drawViz();

  const now=Date.now();

  /* 学習 */
  if(isLearning && now-lastSampleTime>SAMPLE_INTERVAL_MS){
    currentLearn.push(total);
    lastSampleTime=now;
    updateLearnInfo();
    return;
  }

  /* 検知 */
  if(!isDetecting) return;

  const saved=JSON.parse(localStorage.getItem('motionPatterns')||'[]');
  if(!saved.length) return;

  const cand=resample(vizBuffer.slice(-240),60);
  let best=null,bestScore=Infinity;

  for(const p of saved){
    const s=dtwDistance(cand,p.data);
    if(s<bestScore){ bestScore=s; best=p; }
  }

  if(best && bestScore<Number(matchThresh.value)){
    if(now-(lastTriggeredAt[best.name]||0)>Number(cooldown.value)){
      lastTriggeredAt[best.name]=now;
      status(`検出: ${best.name}`);
      playRawSound(best.sound);
      log(`再生: ${best.name}`);
    }
  }
});

/* =========================
   ボタン
   ========================= */
startLearn.onclick=()=>{
  currentLearn=[];
  isLearning=true;
  setTimeout(()=>{
    isLearning=false;
    log(`学習完了 (${currentLearn.length})`);
  },3000);
};

savePatternBtn=savePattern;

startDetectBtn.onclick=()=>{
  isDetecting=true;
  startDetectBtn.disabled=true;
  stopDetectBtn.disabled=false;
  status('検知ON');
};

stopDetectBtn.onclick=()=>{
  isDetecting=false;
  startDetectBtn.disabled=false;
  stopDetectBtn.disabled=true;
  status('停止');
};
</script>
</body>
</html>
