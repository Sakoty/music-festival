<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Motion Learn Minimal</title>

<style>
body{
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background:#f5f7fb;
  margin:0;
  padding:20px;
}
.card{
  background:#fff;
  border-radius:12px;
  padding:16px;
  max-width:480px;
  margin:auto;
  box-shadow:0 8px 24px rgba(0,0,0,.08);
}
button{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  background:#2563eb;
  color:#fff;
  font-weight:600;
  cursor:pointer;
  margin-right:6px;
}
button.secondary{
  background:#e5e7eb;
  color:#111;
}
#status{margin-top:10px;font-weight:600}
#debug{margin-top:6px;font-family:monospace}
</style>
</head>

<body>
<div class="card">
  <h2>Motion Learning（最小構成）</h2>

  <button id="permissionBtn">① センサー許可</button>
  <button id="learnBtn" class="secondary">② 学習（3秒）</button>

  <div id="status">待機中</div>
  <div id="debug">diff: --</div>

  <audio id="sound" src="sound.mp3"></audio>
  <p style="font-size:12px;color:#555">
    ※ sound.mp3 を同じフォルダに置いてください
  </p>
</div>

<script>
/* =====================
   Audio
===================== */
const audio = document.getElementById("sound");

/* =====================
   State
===================== */
let learned = [];
let isLearning = false;
let lastSampleTime = 0;

const SAMPLE_INTERVAL = 25; // ms
const MATCH_THRESHOLD = 6.0;

/* =====================
   Utils
===================== */
function resample(arr, len){
  if(arr.length === 0) return new Array(len).fill(0);
  const out = [];
  for(let i=0;i<len;i++){
    const t = i * (arr.length-1) / (len-1);
    const a = Math.floor(t);
    const b = Math.ceil(t);
    out.push(a===b ? arr[a] : arr[a]*(b-t)+arr[b]*(t-a));
  }
  return out;
}

function diff(a,b){
  let d = 0;
  for(let i=0;i<a.length;i++){
    d += Math.abs(a[i]-b[i]);
  }
  return d / a.length;
}

/* =====================
   UI
===================== */
const statusEl = document.getElementById("status");
const debugEl  = document.getElementById("debug");

/* =====================
   Buttons
===================== */
document.getElementById("permissionBtn").onclick = async ()=>{
  if(typeof DeviceMotionEvent?.requestPermission === "function"){
    const r = await DeviceMotionEvent.requestPermission();
    if(r !== "granted"){
      alert("許可が必要です");
      return;
    }
  }
  statusEl.textContent = "センサー許可OK";
};

document.getElementById("learnBtn").onclick = ()=>{
  learned = [];
  isLearning = true;
  statusEl.textContent = "学習中…（3秒）";
  setTimeout(()=>{
    isLearning = false;
    statusEl.textContent = "学習完了";
    console.log("learned:", learned.length);
  },3000);
};

/* =====================
   Motion
===================== */
window.addEventListener("devicemotion", e=>{
  const acc = e.acceleration; // ★重力除外
  if(!acc) return;

  const now = Date.now();
  if(now - lastSampleTime < SAMPLE_INTERVAL) return;
  lastSampleTime = now;

  const power = Math.sqrt(
    (acc.x||0)**2 +
    (acc.y||0)**2 +
    (acc.z||0)**2
  );

  if(isLearning){
    learned.push(power);
    return;
  }

  if(learned.length < 10) return;

  const recent = resample(learned.slice(-learned.length), 60);
  const current = resample([power], 60);

  const d = diff(recent, current);
  debugEl.textContent = "diff: " + d.toFixed(2);

  if(d < MATCH_THRESHOLD){
    audio.currentTime = 0;
    audio.play();
    statusEl.textContent = "一致！音再生";
  }
});
</script>
</body>
</html>
